<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Classification Management - Codes & Standards</title>
    <!--    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">-->
    <link rel="stylesheet" href="/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
    <!-- Include Sidebar Styles -->
    <th:block th:replace="~{common/sidebar :: sidebar-styles}"></th:block>
    <style>
        body {
            background-color: #f4f6f9;
            margin: 0;
            padding: 0;
            padding-top: 70px;
        }

        .search-box {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .classifications-container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .classification-item {
            background: white;
            border: 1px solid #e0e6ed;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
            position: relative;
            cursor: pointer;
        }
        .classification-item:hover {
            transform: translateY(-4px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.1);
            border-color: #1e3a5f;
        }
        .classification-badge {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 10px;
            background-color: #1e3a5f;
            color: white;
            font-weight: 500;
            font-size: 0.95rem;
        }
        .classification-icon {
            width: 50px;
            height: 50px;
            border-radius: 10px;
            background-color: #fafbfc;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #1e3a5f;
            font-size: 1.5rem;
        }
        .classification-meta {
            font-size: 0.9rem;
            color: #666;
        }

        .loading-spinner {
            display: none;
            text-align: center;
            padding: 40px;
        }
        .empty-state {
            text-align: center;
            padding: 60px 20px;
        }
        .empty-state i {
            font-size: 4rem;
            opacity: 0.3;
            color: #28a745;
        }
        .inline-error {
            color: #dc3545;
            font-size: 0.85rem;
        }

        /* Hover action buttons (hidden by default) */
        .classification-hover-actions {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            gap: 8px;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        /* Show only when hovering on card */
        .classification-item:hover .classification-hover-actions {
            opacity: 1;
            visibility: visible;
        }

        /* Icon buttons */
        .btn-icon {
            border: 1px solid #d1d5db;
            border-radius: 6px;
            background: white;
            padding: 8px 10px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        /* Edit button */
        .edit-btn {
            color: #3b82f6;
            border-color: #3b82f6;
        }
        .edit-btn:hover {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }

        /* Delete button */
        .delete-btn {
            color: #ef4444;
            border-color: #ef4444;
        }
        .delete-btn:hover {
            background: #ef4444;
            color: white;
            border-color: #ef4444;
        }
        #scrollTopBtn {
            display: none;
            position: fixed;
            bottom: 30px;
            right: 30px;
            z-index: 1000;
            background-color: #007bff;
            color: white;
            border: none;
            outline: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            font-size: 20px;
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            transition: background-color 0.3s;
        }

        #scrollTopBtn:hover {
            background-color:#1e3a5f;
        }

        /* Documents Modal Styles */
        .documents-modal-content {
            max-height: 400px;
            overflow-y: auto;
        }

        .document-list-item {
            padding: 12px 15px;
            border-bottom: 1px solid #e5e7eb;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .document-list-item:last-child {
            border-bottom: none;
        }

        .document-list-item:hover {
            background-color: #f3f4f6;
        }

        .document-list-item i {
            color: #1e3a5f;
            font-size: 1.1rem;
        }

        .document-list-item span {
            color: #1a2332;
            font-size: 0.95rem;
            flex: 1;
        }

        .document-list-item .open-icon {
            color: #9ca3af;
            font-size: 0.85rem;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .document-list-item:hover .open-icon {
            opacity: 1;
            color: #1e3a5f;
        }

        .no-documents-message {
            text-align: center;
            padding: 40px 20px;
            color: #6b7a99;
        }

        .no-documents-message i {
            font-size: 3rem;
            opacity: 0.3;
            margin-bottom: 15px;
            display: block;
        }

        .documents-loading {
            text-align: center;
            padding: 40px 20px;
        }
    </style>
</head>
<body>
<!-- Hidden input to store user role from Thymeleaf -->
<input type="hidden" id="userRole" th:value="${#authentication.principal.authorities.iterator().next().authority}">
<input type="hidden" id="userName" th:value="${#authentication.name}">

<!-- Include Top Navbar -->
<div th:replace="~{common/navbar :: navbar}"></div>

<!-- Sidebar + Content -->
<div class="d-flex">
    <!-- Include Sidebar -->
    <div th:replace="~{common/sidebar :: sidebar}"></div>

    <!-- Main Content -->
    <div class="main-content flex-grow-1 p-4">
        <!-- Breadcrumb and Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2 class="mb-1">Classification Management</h2>
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb mb-0">
                        <li class="breadcrumb-item">
                            <a href="javascript:void(0);"
                               onclick="goBack()"
                               class="text-decoration-none">
                                <i class="bi bi-arrow-left me-1"></i> Back
                            </a>
                        </li>
                        <li class="breadcrumb-item">
                            <a th:href="@{/documents}" class="text-decoration-none">
                                <i class="bi bi-house me-1"></i> Home
                            </a>
                        </li>
                        <li class="breadcrumb-item active">Classification Management</li>
                    </ol>
                </nav>
            </div>
            <!-- Create button - Only visible to Admin -->
            <button class="btn " id="createClassificationBtn"
                    data-bs-toggle="modal" data-bs-target="#createClassificationModal"
                    style="display: none; background-color: #1e3a5f; color:#ffffff;">
                <i class="bi bi-plus-circle me-2"></i> Create Classification
            </button>
        </div>

        <!-- Alert Messages Container -->
        <div id="alertContainer"></div>

        <!-- Search Box -->
        <div class="search-box">
            <div class="row align-items-center">
                <div class="col-md-10">
                    <div class="input-group">
                        <span class="input-group-text bg-white"><i class="bi bi-search"></i></span>
                        <input type="text" class="form-control border-start-0" id="searchInput"
                               placeholder="Search classifications by name, creator, or document count...">
                    </div>
                </div>
                <div class="col-md-2 text-end">
                    <span class="text-muted">
                        <i class="bi bi-diagram-3 me-2"></i>
                        Classifications (<span id="classificationCount">0</span>)
                    </span>
                </div>
            </div>
        </div>

        <!-- Loading Spinner -->
        <div class="loading-spinner" id="loadingSpinner">
            <div class="spinner-border" role="status" style="width: 3rem; height: 3rem; color: #1e3a5f">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-3 text-muted">Loading classifications...</p>
        </div>

        <!-- Classifications List Container -->
        <div class="classifications-container" id="classificationsContainer">
            <h5 class="mb-3">
                <i class="bi bi-diagram-3 me-2"></i>
                All Classifications (<span id="totalClassificationsCount">0</span>)
            </h5>

            <div id="classificationsList">
                <!-- Classifications will be loaded here dynamically -->
            </div>

            <!-- Empty State -->
            <div class="empty-state" id="emptyState" style="display: none;">
                <i class="bi bi-diagram-3"></i>
                <p class="text-muted mt-3 fs-5">No classifications found.</p>
                <button class="btn  mt-2" id="emptyCreateBtn"
                        data-bs-toggle="modal" data-bs-target="#createClassificationModal"
                        style="display: none;color: #1e3a5f;">
                    <i class="bi bi-plus-circle me-2"></i> Create Your First Classification
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Create Classification Modal -->
<div class="modal fade" id="createClassificationModal" tabindex="-1"
     data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <form id="createClassificationForm">
                <div class="modal-header text-white" style="background-color: #1e3a5f">
                    <h5 class="modal-title">
                        <i class="bi bi-plus-circle me-2"></i>Create New Classification
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Classification Name <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="createClassificationName" name="classificationName"
                               placeholder="Enter classification name" required minlength="2" maxlength="100">
                        <small class="text-muted">2-100 characters</small>


                        <small class="text-muted">Spaces are not allowed. Name will be converted to lowercase.</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn" style="background-color: #1e3a5f; color:#ffffff;">
                        <i class="bi bi-check-circle me-2"></i>Create Classification
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Classification Modal -->
<div class="modal fade" id="editClassificationModal" tabindex="-1"
     data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <form id="editClassificationForm">
                <input type="hidden" id="editClassificationId">
                <div class="modal-header" style="background-color: #1e3a5f; color:#ffffff;">
                    <h5 class="modal-title">
                        <i class="bi bi-pencil-square me-2"></i>Edit Classification
                    </h5>
                    <button type="button"  class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Classification Name <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="editClassificationName" name="classificationName"
                               required minlength="2" maxlength="100">
                        <small class="text-muted">2-100 characters</small>


                        <small class="text-muted">Spaces are not allowed. Name will be converted to lowercase.</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn" style="background-color: #1e3a5f; color:#ffffff;">
                        <i class="bi bi-check-circle me-2"></i>Update Classification
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1"
     data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content rounded-3 shadow">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">
                    <i class="bi bi-exclamation-triangle me-2"></i>Delete Classification
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p id="deleteModalMessage">Are you sure you want to delete this classification? This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" id="confirmDeleteBtn" class="btn btn-danger">
                    <i class="bi bi-trash me-2"></i> Delete
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Documents by Classification Modal -->
<div class="modal fade" id="documentsModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content rounded-3 shadow">
            <div class="modal-header" style="background-color: #1e3a5f; color:#ffffff;">
                <h5 class="modal-title">
                    <i class="bi bi-files me-2"></i>Documents using classification: <span id="documentsModalClassificationName"></span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-0">
                <div class="documents-loading" id="documentsLoading">
                    <div class="spinner-border" role="status" style="color: #1e3a5f;">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2 text-muted">Loading documents...</p>
                </div>
                <div class="documents-modal-content" id="documentsListContainer">
                    <!-- Documents will be loaded here -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Scroll to Top Button -->
<button id="scrollTopBtn" title="Go to top">
    <i class="bi bi-arrow-up"></i>
</button>

<!--<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>-->
<script src="/js/bootstrap.bundle.min.js"></script>
<!-- Include Navbar JavaScript -->
<div th:replace="~{common/navbar :: navbar-js}"></div>

<script>
    // Configuration
    const API_BASE_URL = '/api/classifications';

    let allClassifications = [];
    let createModal, editModal, deleteModal, documentsModal;
    let deleteClassificationId = null;

    // Get user role from hidden input (populated by Thymeleaf from navbar)
    const userRole = document.getElementById('userRole')?.value || 'Viewer';
    const userName = document.getElementById('userName')?.value || 'User';

    console.log('====== CLASSIFICATION MANAGEMENT ======');
    console.log('User:', userName);
    console.log('Role:', userRole);
    console.log('============================');

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', async function() {
        // Initialize modals
        createModal = new bootstrap.Modal(document.getElementById('createClassificationModal'));
        editModal = new bootstrap.Modal(document.getElementById('editClassificationModal'));
        deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
        documentsModal = new bootstrap.Modal(document.getElementById('documentsModal'));

        // Apply role-based restrictions
        applyRoleBasedRestrictions();

        // Load classifications
        await loadClassifications();

        // Setup event listeners
        setupEventListeners();
    });

    // Apply role-based restrictions
    function applyRoleBasedRestrictions() {
        // Only Admin can create/edit/delete
        const isAdmin = userRole === 'Admin';

        console.log('Can manage (Admin only)?', isAdmin);

        // Show/hide create button based on role
        const createBtn = document.getElementById('createClassificationBtn');
        const emptyCreateBtn = document.getElementById('emptyCreateBtn');

        if (isAdmin) {
            if (createBtn) createBtn.style.display = 'block';
            if (emptyCreateBtn) emptyCreateBtn.style.display = 'block';
        } else {
            if (createBtn) createBtn.style.display = 'none';
            if (emptyCreateBtn) emptyCreateBtn.style.display = 'none';
        }
    }
    // Scroll to top button
        const scrollTopBtn = document.getElementById("scrollTopBtn");
        if (scrollTopBtn) {
            window.onscroll = function() {
                if (document.body.scrollTop > 200 || document.documentElement.scrollTop > 200) {
                    scrollTopBtn.style.display = "block";
                } else {
                    scrollTopBtn.style.display = "none";
                }
            };

            scrollTopBtn.addEventListener("click", function() {
                window.scrollTo({
                    top: 0,
                    behavior: 'smooth'
                });
            });
        }

    // Setup all event listeners
    function setupEventListeners() {
        // Create form submit
        document.getElementById('createClassificationForm').addEventListener('submit', handleCreateClassification);

        // Edit form submit
        document.getElementById('editClassificationForm').addEventListener('submit', handleEditClassification);

        // Delete confirmation
        document.getElementById('confirmDeleteBtn').addEventListener('click', handleDeleteClassification);

        // Search functionality
        document.getElementById('searchInput').addEventListener('keyup', handleSearch);

        // Reset create form when modal is closed
        document.getElementById('createClassificationModal').addEventListener('hidden.bs.modal', function() {
            document.getElementById('createClassificationForm').reset();
        });

        // Reset edit form when modal is closed
        document.getElementById('editClassificationModal').addEventListener('hidden.bs.modal', function() {
            document.getElementById('editClassificationForm').reset();
            document.getElementById('editClassificationId').value = '';
        });
    }

    // Load all classifications
    async function loadClassifications() {
        showLoading(true);
        try {
            const response = await fetch(API_BASE_URL, {
                credentials: 'same-origin',
                headers: {
                    'Accept': 'application/json'
                }
            });

            if (!response.ok) {
                if (response.status === 401 || response.status === 403) {
                    window.location.href = '/login';
                    return;
                }
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            allClassifications = await response.json();
            console.log('Classifications loaded:', allClassifications.length);
            displayClassifications(allClassifications);
            updateClassificationCount(allClassifications.length);

        } catch (error) {
            console.error('Error loading classifications:', error);
            showAlert('Failed to load classifications. Please try again.', 'danger');
        } finally {
            showLoading(false);
        }
    }

    // Display classifications in the list
    function displayClassifications(classifications) {
        const classificationsList = document.getElementById('classificationsList');
        const emptyState = document.getElementById('emptyState');

        if (classifications.length === 0) {
            classificationsList.innerHTML = '';
            emptyState.style.display = 'block';
            return;
        }

        emptyState.style.display = 'none';
        classificationsList.innerHTML = '';

        classifications.forEach(classification => {
            const classificationItem = createClassificationElement(classification);
            classificationsList.appendChild(classificationItem);
        });
    }

    // Create classification element with hover actions
    function createClassificationElement(classification) {
        const div = document.createElement('div');
        div.className = 'classification-item position-relative';
        div.setAttribute('data-classification-id', classification.id);

        const createdDate = formatDate(classification.createdAt);
        const updatedDate = formatDate(classification.updatedAt);
        const updatedBy = classification.updatedByUsername || 'N/A';
        const createdBy = classification.createdByUsername || 'Unknown';

        // Only Admin can edit/delete
        const isAdmin = userRole === 'Admin';

        // Hover action buttons (instead of dropdown)
        const actionsHTML = isAdmin ? `
            <div class="classification-hover-actions">
                <button class="btn-icon edit-btn" title="Edit"
                    onclick="event.stopPropagation(); openEditModal(${classification.id}, '${escapeHtml(classification.classificationName).replace(/'/g, "\\'")}')">
                    <i class="bi bi-pencil"></i>
                </button>
                <button class="btn-icon delete-btn" title="Delete"
                    onclick="event.stopPropagation(); openDeleteModal(${classification.id}, '${escapeHtml(classification.classificationName).replace(/'/g, "\\'")}', ${classification.documentCount || 0})">
                    <i class="bi bi-trash"></i>
                </button>
            </div>
        ` : '';

        div.innerHTML = `
            <div class="d-flex align-items-start">
                <!-- Classification Icon -->
                <div class="classification-icon me-3">
                    <i class="bi bi-diagram-3-fill"></i>
                </div>

                <!-- Classification Details -->
                <div class="flex-grow-1">
                    <div class="mb-2">
                        <span class="classification-badge">${escapeHtml(classification.classificationName)}</span>
                    </div>
                    <div class="classification-meta">
                        <span class="me-3">
                            <i class="bi bi-person me-1"></i>
                            Created by <strong>${escapeHtml(createdBy)}</strong>
                        </span>
                        <span class="me-3">
                            <i class="bi bi-calendar me-1"></i>
                            On <span>${createdDate}</span>
                        </span>
                        <span class="me-3">
                            <i class="bi bi-files me-1"></i>
                            <strong>${classification.documentCount || 0}</strong> document(s)
                        </span>
                        <span class="me-3">
                            <i class="bi bi-clock me-1"></i>
                            Updated By <strong>${escapeHtml(updatedBy)}</strong>
                        </span>
                        <span class="me-3">
                            <i class="bi bi-calendar-check me-1"></i>
                            Updated On <span>${updatedDate}</span>
                        </span>
                    </div>
                </div>

                ${actionsHTML}
            </div>
        `;

        // Add click event to open documents modal
        div.addEventListener('click', function(e) {
            // Don't trigger if clicking on action buttons
            if (e.target.closest('.classification-hover-actions')) {
                return;
            }
            openDocumentsModal(classification.id, classification.classificationName);
        });

        return div;
    }

    // Open documents modal
    async function openDocumentsModal(classificationId, classificationName) {
        // Set the classification name in modal title
        document.getElementById('documentsModalClassificationName').textContent = classificationName;

        // Show loading state
        document.getElementById('documentsLoading').style.display = 'block';
        document.getElementById('documentsListContainer').innerHTML = '';

        // Show modal
        documentsModal.show();

        try {
            // Fetch documents for this classification
            const response = await fetch(`${API_BASE_URL}/${classificationId}/documents`, {
                credentials: 'same-origin',
                headers: {
                    'Accept': 'application/json'
                }
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const documents = await response.json();

            // Hide loading
            document.getElementById('documentsLoading').style.display = 'none';

            // Display documents
            displayDocumentsInModal(documents);

        } catch (error) {
            console.error('Error loading documents:', error);
            document.getElementById('documentsLoading').style.display = 'none';
            document.getElementById('documentsListContainer').innerHTML = `
                <div class="no-documents-message">
                    <i class="bi bi-exclamation-circle"></i>
                    <p>Failed to load documents. Please try again.</p>
                </div>
            `;
        }
    }

    // Display documents in modal
    function displayDocumentsInModal(documents) {
        const container = document.getElementById('documentsListContainer');

        if (!documents || documents.length === 0) {
            container.innerHTML = `
                <div class="no-documents-message">
                    <i class="bi bi-file-earmark-x"></i>
                    <p>No documents using this classification</p>
                </div>
            `;
            return;
        }

        let html = '';
        documents.forEach(doc => {
            html += `
                <div class="document-list-item" onclick="openDocument(${doc.id})">
                    <i class="bi bi-file-earmark-text"></i>
                    <span>${escapeHtml(doc.title)}</span>
                    <i class="bi bi-box-arrow-up-right open-icon"></i>
                </div>
            `;
        });

        container.innerHTML = html;
    }

    // Open document in DocViewer
    function openDocument(docId) {
        window.open(`/DocViewer?id=${docId}`, '_blank');
    }

    // Handle create classification (Admin only)
    async function handleCreateClassification(e) {
        e.preventDefault();

        // Check if user is Admin
        if (userRole !== 'Admin') {
            showAlert('Only Admin users can create classifications.', 'danger');
            return;
        }

        const input = document.getElementById('createClassificationName');
        // Remove spaces and convert to lowercase
        let classificationName = input.value.trim().toLowerCase().replace(/\s+/g, '');
        const errorEl = getOrCreateErrorElement(input);

        // Remove old error text
        errorEl.textContent = '';

        // Validation: length
        if (classificationName.length < 2 || classificationName.length > 100) {
            errorEl.textContent = 'Classification name must be between 2 and 100 characters (no spaces).';
            return;
        }

        // Validation: check duplicate
        const exists = allClassifications.some(c => c.classificationName.toLowerCase() === classificationName);
        if (exists) {
            errorEl.textContent = `Classification "${classificationName}" already exists.`;
            return;
        }

        try {
            const response = await fetch(API_BASE_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'same-origin',
                body: JSON.stringify({ classificationName })
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || 'Failed to create classification');
            }

            createModal.hide();
            input.value = '';
            await loadClassifications();
            showAlert('Classification created successfully!', 'success');

        } catch (error) {
            errorEl.textContent = error.message || 'Failed to create classification.';
        }
    }

    // Open edit modal (Admin only)
    function openEditModal(classificationId, classificationName) {
        // Check if user is Admin
        if (userRole !== 'Admin') {
            showAlert('Only Admin users can edit classifications.', 'danger');
            return;
        }

        document.getElementById('editClassificationId').value = classificationId;
        document.getElementById('editClassificationName').value = classificationName;
        editModal.show();
    }

    // Handle edit classification (Admin only)
    async function handleEditClassification(e) {
        e.preventDefault();

        // Check if user is Admin
        if (userRole !== 'Admin') {
            showAlert('Only Admin users can edit classifications.', 'danger');
            return;
        }

        const input = document.getElementById('editClassificationName');
        // Remove spaces and convert to lowercase
        let classificationName = input.value.trim().toLowerCase().replace(/\s+/g, '');
        const classificationId = document.getElementById('editClassificationId').value;
        const errorEl = getOrCreateErrorElement(input);

        errorEl.textContent = '';

        if (classificationName.length < 2 || classificationName.length > 100) {
            errorEl.textContent = 'Classification name must be between 2 and 100 characters (no spaces).';
            return;
        }

        const exists = allClassifications.some(c => c.classificationName.toLowerCase() === classificationName && c.id != classificationId);
        if (exists) {
            errorEl.textContent = `Classification "${classificationName}" already exists.`;
            return;
        }

        try {
            const response = await fetch(`${API_BASE_URL}/${classificationId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'same-origin',
                body: JSON.stringify({ classificationName })
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || 'Failed to update classification');
            }

            editModal.hide();
            await loadClassifications();
            showAlert('Classification updated successfully!', 'success');

        } catch (error) {
            errorEl.textContent = error.message || 'Failed to update classification.';
        }
    }

    // Helper function to show inline error message below input
    function getOrCreateErrorElement(input) {
        let errorEl = input.parentElement.querySelector('.text-danger.inline-error');
        if (!errorEl) {
            errorEl = document.createElement('div');
            errorEl.className = 'text-danger inline-error mt-1 small';
            input.parentElement.appendChild(errorEl);
        }
        return errorEl;
    }

    // Open delete modal (Admin only)
    function openDeleteModal(classificationId, classificationName, documentCount) {
        // Check if user is Admin
        if (userRole !== 'Admin') {
            showAlert('Only Admin users can delete classifications.', 'danger');
            return;
        }

        deleteClassificationId = classificationId;

        // Show different message based on document count
        if (documentCount > 0) {
            document.getElementById('deleteModalMessage').innerHTML =
                `Are you sure you want to delete the classification "<strong>${classificationName}</strong>"?


                <span class="text-warning"><i class="fas fa-exclamation-triangle"></i>
                This classification is being used by ${documentCount} document(s).
                The classification will be removed from all documents, but the documents will remain intact.</span>`;
        } else {
            document.getElementById('deleteModalMessage').textContent =
                `Are you sure you want to delete the classification "${classificationName}"? This action cannot be undone.`;
        }

        deleteModal.show();
    }

    // Handle delete classification (Admin only)
    async function handleDeleteClassification() {
        if (!deleteClassificationId) return;

        // Check if user is Admin
        if (userRole !== 'Admin') {
            showAlert('Only Admin users can delete classifications.', 'danger');
            deleteModal.hide();
            return;
        }

        try {
            const response = await fetch(`${API_BASE_URL}/${deleteClassificationId}`, {
                method: 'DELETE',
                credentials: 'same-origin'
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || 'Failed to delete classification');
            }

            showAlert('Classification deleted successfully!', 'success');
            deleteModal.hide();
            deleteClassificationId = null;
            await loadClassifications();

        } catch (error) {
            console.error('Error deleting classification:', error);
            showAlert(error.message || 'Failed to delete classification. Please try again.', 'danger');
            deleteModal.hide();
        }
    }

    // Handle search
    function handleSearch() {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        const classificationItems = document.querySelectorAll('.classification-item');
        let visibleCount = 0;

        classificationItems.forEach(item => {
            const text = item.textContent.toLowerCase();
            if (text.includes(searchTerm)) {
                item.style.display = '';
                visibleCount++;
            } else {
                item.style.display = 'none';
            }
        });

        updateClassificationCount(visibleCount);
    }

    // Update classification count
    function updateClassificationCount(count) {
        document.getElementById('classificationCount').textContent = count;
        document.getElementById('totalClassificationsCount').textContent = count;
    }

    // Date formatting function
    function formatDate(dateString) {
        if (!dateString || dateString === 'N/A') return 'N/A';

        try {
            const date = new Date(dateString);
            if (isNaN(date.getTime())) return dateString;

            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun',
                          'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

            const day = String(date.getDate()).padStart(2, '0');
            const month = months[date.getMonth()];
            const year = date.getFullYear();

            return `${month} ${day}, ${year}`;
        } catch (error) {
            return dateString;
        }
    }

    // Show alert message
    function showAlert(message, type) {
        const alertContainer = document.getElementById('alertContainer');
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show`;

        const icon = type === 'success' ? 'check-circle-fill' :
                     type === 'danger' ? 'exclamation-circle-fill' :
                     type === 'warning' ? 'exclamation-triangle-fill' :
                     'info-circle-fill';

        alertDiv.innerHTML = `
            <i class="bi bi-${icon} me-2"></i>
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;

        alertContainer.appendChild(alertDiv);

        // Auto-dismiss after 5 seconds
        setTimeout(() => {
            alertDiv.remove();
        }, 5000);
    }

    // Show/hide loading spinner
    function showLoading(show) {
        document.getElementById('loadingSpinner').style.display = show ? 'block' : 'none';
        document.getElementById('classificationsContainer').style.display = show ? 'none' : 'block';
    }

    // Escape HTML to prevent XSS
    function escapeHtml(text) {
        if (!text) return '';
        const map = {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#039;'
        };
        return String(text).replace(/[&<>"']/g, m => map[m]);
    }
</script>
<script>
    function goBack() {
        if (document.referrer && document.referrer !== window.location.href) {
            // Go to the referring page if available
            window.history.back();
        } else {
            // Fallback if there's no referrer (like direct load)
            window.location.href = '/documents';
        }
    }
</script>
</body>
</html>