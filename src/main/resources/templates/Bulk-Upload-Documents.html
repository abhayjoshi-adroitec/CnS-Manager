<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bulk Upload Documents - Codes & Standards</title>
    <link rel="stylesheet" href="/css/bootstrap.min.css">
    <link rel="stylesheet" href="/fontawesome/css/all.min.css">
    <link rel="stylesheet" href="/bootstrap-icons/bootstrap-icons.css">
    <script src="/pdfjs/pdf.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

    <th:block th:replace="~{common/sidebar :: sidebar-styles}"></th:block>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        body{background-color:#f4f6f9;padding-top:70px}
        .wizard-container{max-width:1400px;margin:0 auto;background:#fff;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,0.1);overflow:hidden}
        .wizard-header{background-color:#1e3a5f;padding:30px;color:#fff}
        .wizard-header h2{margin:0;font-size:24px;font-weight:600}
        .wizard-header p{margin:5px 0 0;opacity:.9;font-size:14px}
        .wizard-steps{display:flex;justify-content:space-between;align-items:center;padding:30px 50px;background:#f8f9fa;position:relative}
        .wizard-steps::before{content:'';position:absolute;top:50%;left:50px;right:50px;height:2px;background:#e0e0e0;z-index:0}
        .wizard-step{display:flex;flex-direction:column;align-items:center;position:relative;z-index:1;flex:1}
        .wizard-step-circle{width:50px;height:50px;border-radius:50%;background:#fff;border:3px solid #e0e0e0;display:flex;align-items:center;justify-content:center;font-weight:600;font-size:18px;color:#9ca3af;transition:all .3s;margin-bottom:10px}
        .wizard-step.active .wizard-step-circle{background:#667eea;border-color:#667eea;color:#fff;box-shadow:0 0 0 4px rgba(102,126,234,0.2)}
        .wizard-step.completed .wizard-step-circle{background:#10b981;border-color:#10b981;color:#fff}
        .wizard-step-label{font-size:14px;font-weight:500;color:#6b7280;text-align:center}
        .wizard-step.active .wizard-step-label{color:#667eea;font-weight:600}
        .wizard-step.completed .wizard-step-label{color:#10b981}
        .wizard-content{padding:40px 50px;min-height:450px;position:relative}
        .wizard-step-content{display:none;height:100%}
        .wizard-step-content.active{display:block;animation:fadeIn .4s}
        @keyframes fadeIn{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
        .wizard-navigation{display:flex;justify-content:space-between;padding:20px 50px 30px;border-top:1px solid #e5e7eb}
        .wizard-btn{padding:12px 32px;border-radius:8px;font-size:14px;font-weight:600;border:none;cursor:pointer;transition:all .3s;display:inline-flex;align-items:center;gap:8px}
        .wizard-btn-secondary{background:#f3f4f6;color:#374151}
        .wizard-btn-secondary:hover{background:#e5e7eb}
        .wizard-btn-primary{background:#667eea;color:#fff}
        .wizard-btn-primary:hover{background:#5568d3}
        .wizard-btn-primary:disabled{background:#d1d5db;cursor:not-allowed}
        .wizard-btn-success{background:#10b981;color:#fff}
        .wizard-btn-success:hover{background:#059669}
        .wizard-btn-warning{background:#f59e0b;color:#fff}
        .wizard-btn-warning:hover{background:#d97706}

        .drop-zone{border:3px dashed #d1d5db;border-radius:12px;padding:80px 40px;text-align:center;background:linear-gradient(135deg,#fafbfc 0,#f0f7ff 100%);cursor:pointer;transition:all .3s;position:relative}
        .drop-zone:hover{border-color:#667eea;background:linear-gradient(135deg,#f0f7ff 0,#e0f2fe 100%);transform:scale(1.02)}
        .drop-zone.dragover{border-color:#667eea;background:linear-gradient(135deg,#e0f7ff 0,#dbeafe 100%);border-style:solid;transform:scale(1.05)}
        .drop-zone-icon{width:80px;height:80px;margin:0 auto 20px;color:#667eea}
        .drop-zone-text{font-size:20px;color:#1a2332;margin-bottom:10px;font-weight:600}
        .drop-zone-info{font-size:14px;color:#6b7a99;margin-bottom:25px}
        .browse-btn{background:#667eea;color:#fff;padding:14px 36px;border-radius:8px;font-size:15px;font-weight:600;cursor:pointer;transition:all .3s;border:none;display:inline-flex;align-items:center;gap:10px}
        .browse-btn:hover{background:#5568d3;transform:translateY(-2px);box-shadow:0 4px 12px rgba(102,126,234,0.4)}

        .folder-uploaded-message{display:none;background:#ecfdf5;border:2px solid #10b981;border-radius:12px;padding:30px;margin-top:30px}
        .folder-uploaded-message.show{display:block;animation:slideIn .4s}
        @keyframes slideIn{from{opacity:0;transform:translateX(-20px)}to{opacity:1;transform:translateX(0)}}
        .folder-uploaded-icon{width:80px;height:80px;background:#10b981;border-radius:50%;display:flex;align-items:center;justify-content:center;margin:0 auto 20px;color:#fff;font-size:40px}
        .folder-uploaded-title{text-align:center;font-size:20px;font-weight:600;color:#065f46;margin-bottom:10px}
        .folder-uploaded-details{text-align:center;font-size:14px;color:#047857;margin-bottom:20px}
        .change-file-btn{background:#10b981;color:#fff;padding:10px 24px;border-radius:8px;font-size:14px;font-weight:600;border:none;cursor:pointer;transition:all .3s;display:inline-flex;align-items:center;gap:8px}
        .change-file-btn:hover{background:#059669}
        .file-list{max-height:250px;overflow-y:auto;margin-top:15px;background:#fff;border-radius:8px;padding:10px;border:1px solid #e5e7eb}
        .file-list-header{display:flex;align-items:center;justify-content:space-between;padding:8px 12px;border-bottom:1px solid #e5e7eb;font-size:13px;color:#374151;font-weight:600}
        .file-list-item{padding:8px 12px;border-bottom:1px solid #e5e7eb;display:flex;align-items:center;gap:10px;font-size:13px;color:#374151}
        .file-list-item:last-child{border-bottom:none}
        .file-checkbox{flex-shrink:0}
        .file-name-wrapper{display:flex;align-items:center;gap:6px;flex:1;min-width:0}
        .file-name-text{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
        .protected-badge{display:inline-flex;align-items:center;gap:4px;background:#fef3c7;color:#92400e;padding:2px 6px;border-radius:4px;font-size:11px}

        .info-box{background:#eff6ff;border-left:4px solid #3b82f6;padding:20px;border-radius:8px;margin-bottom:30px}
        .info-box-title{font-weight:600;color:#1e40af;margin-bottom:10px;display:flex;align-items:center;gap:8px}
        .info-box-content{color:#1e40af;font-size:14px;line-height:1.6}
        .download-template-btn{background:#10b981;color:#fff;padding:12px 24px;border-radius:8px;font-size:14px;font-weight:600;border:none;cursor:pointer;transition:all .3s;display:inline-flex;align-items:center;gap:8px;text-decoration:none;margin-bottom:10px}
        .download-template-btn:hover{background:#059669;transform:translateY(-2px);color:#fff}
        .template-note{font-size:13px;color:#6b7280;margin-top:10px}

        /* Step 4 self validation */
        .self-validation-title{font-size:18px;font-weight:600;color:#1a2332}
        .self-validation-info{font-size:12px;color:#6b7280;margin-top:4px}
        .self-validation-table-wrapper{border-radius:8px;border:1px solid #e5e7eb;background:#fff;overflow:auto;max-height:100%}
        table.self-validation-table{width:100%;border-collapse:collapse;font-size:12px}
        table.self-validation-table thead{background:#f9fafb;position:sticky;top:0;z-index:1}
        table.self-validation-table th,table.self-validation-table td{padding:6px 8px;border-bottom:1px solid #e5e7eb;vertical-align:middle}
        table.self-validation-table th{font-weight:600;color:#4b5563;white-space:nowrap}
        table.self-validation-table td input{width:100%;border-radius:6px;border:1px solid #d1d5db;padding:3px 5px;font-size:12px}
        table.self-validation-table td input[readonly]{background-color:#f9fafb;color:#6b7280;cursor:not-allowed}

        /* multi-select dropdown */
        .multi-select-container{position:relative}
        .multi-select-display{
            display:flex;align-items:center;justify-content:space-between;
            border:1px solid #d1d5db;border-radius:6px;padding:4px 6px;
            background:#f9fafb;font-size:12px;cursor:pointer;
        }
        .multi-select-display span{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
        .multi-select-panel{
            position:absolute;top:100%;left:0;right:0;z-index:20;
            background:#fff;border:1px solid #d1d5db;border-radius:6px;
            margin-top:4px;max-height:220px;overflow-y:auto;
            box-shadow:0 4px 12px rgba(0,0,0,0.15);
        }
        .multi-select-search{padding:6px 8px;border-bottom:1px solid #e5e7eb;}
        .multi-select-search input{
            width:100%;border-radius:4px;border:1px solid #d1d5db;
            padding:4px 6px;font-size:12px;
        }
        .multi-select-option{
            padding:6px 10px;display:flex;align-items:center;gap:8px;
            font-size:12px;cursor:pointer;
        }
        .multi-select-option:hover{background:#f3f4f6;}
        .multi-select-footer{
            padding:6px 10px;border-top:1px solid #e5e7eb;font-size:12px;color:#6b7280;
        }

        .validation-results{background:#f9fafb;border-radius:12px;padding:25px;margin-bottom:20px}
        .validation-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}
        .validation-title{font-size:18px;font-weight:600;color:#1a2332}
        .validation-status{padding:8px 16px;border-radius:20px;font-size:13px;font-weight:600}
        .validation-status.success{background:#d1fae5;color:#065f46}
        .validation-status.warning{background:#fef3c7;color:#92400e}
        .validation-status.error{background:#fee2e2;color:#991b1b}
        .validation-stats{display:grid;grid-template-columns:repeat(4,1fr);gap:15px;margin-bottom:20px}
        .stat-card{background:#fff;padding:20px;border-radius:8px;text-align:center;border:2px solid #e5e7eb}
        .stat-number{font-size:32px;font-weight:700;margin-bottom:5px}
        .stat-label{font-size:13px;color:#6b7280;font-weight:500}
        .stat-card.total .stat-number{color:#3b82f6}
        .stat-card.valid .stat-number{color:#10b981}
        .stat-card.warnings .stat-number{color:#f59e0b}
        .stat-card.errors .stat-number{color:#ef4444}
        .validation-issues{background:#fff;border-radius:8px;overflow:hidden;max-height:300px;overflow-y:auto}
        .issue-item{padding:15px 20px;border-bottom:1px solid #e5e7eb;display:flex;align-items:flex-start;gap:12px}
        .issue-item:last-child{border-bottom:none}
        .issue-icon{width:24px;height:24px;border-radius:50%;display:flex;align-items:center;justify-content:center;flex-shrink:0}
        .issue-icon.warning{background:#fef3c7;color:#f59e0b}
        .issue-icon.error{background:#fee2e2;color:#ef4444}
        .issue-content{flex:1}
        .issue-title{font-weight:600;color:#1a2332;margin-bottom:4px}
        .issue-desc{font-size:14px;color:#6b7280}
        .validation-error-actions{display:none;margin-top:20px;padding:20px;background:#fef3c7;border-radius:8px;border-left:4px solid #f59e0b}
        .validation-error-actions.show{display:block}
        .validation-error-actions h4{font-size:16px;font-weight:600;color:#92400e;margin-bottom:15px;display:flex;align-items:center;gap:8px}
        .validation-error-actions p{font-size:14px;color:#92400e;margin-bottom:15px}
        .error-action-buttons{display:flex;gap:12px;flex-wrap:wrap}
        .error-action-btn{padding:10px 20px;border-radius:8px;font-size:14px;font-weight:600;border:none;cursor:pointer;transition:all .3s;display:inline-flex;align-items:center;gap:8px}
        .error-action-btn.reupload-folder{background:#667eea;color:#fff}
        .error-action-btn.reupload-folder:hover{background:#5568d3}
        .error-action-btn.reupload-excel{background:#10b981;color:#fff}
        .error-action-btn.reupload-excel:hover{background:#059669}
        .error-action-btn.upload-valid{background:#f59e0b;color:#fff}
        .error-action-btn.upload-valid:hover{background:#d97706}

        .progress-container{background:#f9fafb;border-radius:12px;padding:30px}
        .progress-header{text-align:center;margin-bottom:30px}
        .progress-title{font-size:20px;font-weight:600;color:#1a2332;margin-bottom:10px}
        .progress-subtitle{color:#6b7280;font-size:14px}
        .progress-bar-container{background:#fff;border-radius:8px;padding:20px;margin-bottom:20px}
        .progress-bar-wrapper{background:#e5e7eb;height:30px;border-radius:15px;overflow:hidden;margin-bottom:10px}
        .progress-bar-fill{height:100%;background:linear-gradient(90deg,#667eea 0,#764ba2 100%);border-radius:15px;transition:width .3s;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:600;font-size:14px}
        .progress-text{text-align:center;color:#6b7280;font-size:14px}
        .upload-log{background:#fff;border-radius:8px;max-height:300px;overflow-y:auto}
        .log-item{padding:12px 20px;border-bottom:1px solid #e5e7eb;display:flex;align-items:center;gap:12px;font-size:14px}
        .log-item:last-child{border-bottom:none}
        .log-icon{width:20px;height:20px;border-radius:50%;display:flex;align-items:center;justify-content:center;flex-shrink:0}
        .log-icon.success{background:#d1fae5;color:#10b981}
        .log-icon.error{background:#fee2e2;color:#ef4444}
        .log-icon.processing{background:#dbeafe;color:#3b82f6}

        .custom-modal-overlay{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:9999;align-items:center;justify-content:center;animation:fadeIn .3s}
        .custom-modal-overlay.show{display:flex}
        .custom-modal{background:#fff;border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,0.3);max-width:600px;width:90%;max-height:80vh;animation:slideUp .3s;overflow:hidden;display:flex;flex-direction:column}
        @keyframes slideUp{from{opacity:0;transform:translateY(30px)}to{opacity:1;transform:translateY(0)}}
        .modal-header-custom{padding:25px 30px;background-color:#1e3a5f;color:#fff;display:flex;align-items:center;gap:15px}
        .modal-header-warning{background-color:#1e3a5f;}
        .modal-header-danger{background-color:#1e3a5f;}
        .modal-icon{width:50px;height:50px;background:rgba(255,255,255,0.2);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:24px}
        .modal-title-custom{flex:1}
        .modal-title-custom h3{margin:0;font-size:20px;font-weight:600}
        .modal-title-custom p{margin:5px 0 0;font-size:13px;opacity:.9}
        .modal-close-btn{width:32px;height:32px;border-radius:50%;background:rgba(255,255,255,0.2);border:none;color:#fff;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .3s}
        .modal-close-btn:hover{background:rgba(255,255,255,0.3);transform:rotate(90deg)}
        .modal-body-custom{padding:30px;overflow-y:auto;flex:1}
        .protected-files-list{max-height:200px;overflow-y:auto;background:#f9fafb;border-radius:8px;padding:10px;margin-top:15px}
        .protected-file-item{padding:10px;background:#fff;border-radius:6px;margin-bottom:8px;border-left:3px solid #f59e0b}
        .protected-file-item:last-child{margin-bottom:0}
        .protected-file-name{font-weight:600;color:#1a2332;margin-bottom:5px;font-size:14px}
        .protected-file-issues{font-size:13px;color:#6b7280}
        .protected-file-issues span{display:inline-block;background:#fef3c7;color:#92400e;padding:2px 8px;border-radius:4px;margin-right:5px;margin-top:3px;font-size:12px}
        .modal-footer-custom{padding:20px 30px;background:#f9fafb;display:flex;justify-content:flex-end;gap:12px}
        .modal-btn{padding:10px 24px;border-radius:8px;font-size:14px;font-weight:600;border:none;cursor:pointer;transition:all .3s}
        .modal-btn-secondary{background:#fff;color:#374151;border:2px solid #e5e7eb}
        .modal-btn-secondary:hover{background:#1e3a5f}
        .modal-btn-danger{background:#ef4444;color:#fff}
        .modal-btn-danger:hover{background:#dc2626}
        .modal-btn-warning{background:#1e3a5f;color:#fff}
        .modal-btn-warning:hover{background:#1e3a5f}
        .alert{border-radius:8px;padding:15px 20px;margin-bottom:20px;display:flex;align-items:center;gap:10px}
        .alert i{font-size:20px}
        @keyframes slideInRight{from{opacity:0;transform:translateX(100px)}to{opacity:1;transform:translateX(0)}}
        @keyframes slideOutRight{from{opacity:1;transform:translateX(0)}to{opacity:0;transform:translateX(100px)}}
        @media (max-width:992px){.wizard-steps{padding:20px 30px}.wizard-content{padding:30px 30px}.wizard-navigation{padding:15px 30px 20px}.validation-stats{grid-template-columns:repeat(2,1fr)}}
        @media (max-width:768px){.wizard-steps::before{left:30px;right:30px}.wizard-step-label{font-size:12px}.wizard-step-circle{width:40px;height:40px;font-size:16px}.error-action-buttons{flex-direction:column}.error-action-btn{width:100%;justify-content:center}}
        .skipped-doc-item {
            padding: 8px 12px;
            background: #fff;
            border-radius: 6px;
            margin-bottom: 6px;
            border-left: 3px solid #ef4444;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 13px;
            color: #1a2332;
        }
        .skipped-doc-item:last-child {
            margin-bottom: 0;
        }
        .skipped-doc-item i {
            font-size: 16px;
            flex-shrink: 0;
        }
        .skipped-doc-item span {
            flex: 1;
            word-break: break-word;
        }
    </style>
</head>
<body>
<div th:replace="~{common/navbar :: navbar}"></div>
<div class="d-flex">
    <div th:replace="~{common/sidebar :: sidebar}"></div>
    <div class="main-content flex-grow-1 p-4">
        <div th:if="${success}" class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="bi bi-check-circle-fill"></i>
            <span th:text="${success}">Documents uploaded successfully!</span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        <div th:if="${error}" class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="bi bi-exclamation-circle-fill"></i>
            <span th:text="${error}">Error uploading documents!</span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>

        <div class="wizard-container">
            <div class="wizard-header">
                <h2><i class="bi bi-folder-symlink me-2"></i>Bulk Upload Documents</h2>
                <p>Upload multiple documents at once using folder selection and Excel metadata</p>
            </div>

            <!-- 6 steps -->
            <div class="wizard-steps">
                <div class="wizard-step active" data-step="1">
                    <div class="wizard-step-circle"><i class="bi bi-folder2-open"></i></div>
                    <div class="wizard-step-label">Bulk Upload</div>
                </div>
                <div class="wizard-step" data-step="2">
                    <div class="wizard-step-circle"><i class="bi bi-file-earmark-arrow-down"></i></div>
                    <div class="wizard-step-label">Download Template</div>
                </div>
                <div class="wizard-step" data-step="3">
                    <div class="wizard-step-circle"><i class="bi bi-file-earmark-excel"></i></div>
                    <div class="wizard-step-label">Upload Metadata</div>
                </div>
                <div class="wizard-step" data-step="4">
                    <div class="wizard-step-circle"><i class="bi bi-pencil-square"></i></div>
                    <div class="wizard-step-label">Self Validation</div>
                </div>
                <div class="wizard-step" data-step="5">
                    <div class="wizard-step-circle"><i class="bi bi-check-square"></i></div>
                    <div class="wizard-step-label">Validation</div>
                </div>
                <div class="wizard-step" data-step="6">
                    <div class="wizard-step-circle"><i class="bi bi-cloud-upload"></i></div>
                    <div class="wizard-step-label">Upload</div>
                </div>
            </div>

            <div class="wizard-content">
                <!-- Step 1 -->
                <div class="wizard-step-content active" data-step="1">
                    <div class="drop-zone" id="dropZone">
                        <svg class="drop-zone-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                  d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"/>
                        </svg>
                        <div class="drop-zone-text">Select Folder with PDF Files</div>
                        <div class="drop-zone-info">Choose a folder containing all your PDF documents</div>
                        <div class="drop-zone-info" style="margin-bottom:20px;">
                            <i class="bi bi-info-circle"></i> All checked PDF files will be processed
                        </div>
                        <button type="button" class="browse-btn" onclick="triggerFolderSelection()">
                            <i class="bi bi-folder2-open"></i> Browse Folder
                        </button>
                        <input type="file" id="folderInput" webkitdirectory directory multiple style="display:none;">
                    </div>

                    <div class="folder-uploaded-message" id="folderUploadedMessage">
                        <div class="folder-uploaded-icon"><i class="bi bi-check-circle-fill"></i></div>
                        <div class="folder-uploaded-title">Folder Selected Successfully!</div>
                        <div class="folder-uploaded-details">
                            <strong id="uploadedFileCount">0 PDF files</strong> •
                            <span id="uploadedFileSize">0 MB</span>
                        </div>
                        <button type="button" class="change-file-btn" onclick="changeFolder()">
                            <i class="bi bi-arrow-repeat"></i> Change Folder
                        </button>
                        <div class="file-list" id="fileList"></div>
                    </div>
                </div>

                <!-- Step 2 -->
                <div class="wizard-step-content" data-step="2">
                    <div class="info-box">
                        <div class="info-box-title">
                            <i class="bi bi-info-circle-fill"></i>Download Metadata Template
                        </div>
                        <div class="info-box-content">
                            Use this step to download the Excel template for metadata entry if needed.
                            <ul style="margin-top:10px;">
                                <li>You can skip downloading if you already have metadata Excel.</li>
                                <li>Template helps you map document metadata and classifications.</li>
                                <li>Protected PDFs can have page numbers entered manually in Excel.</li>
                            </ul>
                        </div>
                    </div>
                    <button type="button" class="download-template-btn" id="downloadTemplateBtn">
                        <i class="bi bi-download"></i> Download Template
                    </button>
                    <div class="template-note">
                        You may go next without downloading if your metadata file already exists.
                    </div>
                </div>

                <!-- Step 3 -->
                <div class="wizard-step-content" data-step="3">
                    <div class="info-box">
                        <div class="info-box-title">
                            <i class="bi bi-info-circle-fill"></i>Upload Metadata Excel
                        </div>
                        <div class="info-box-content">
                            Upload the Excel file that contains metadata for the selected documents.
                            <ul style="margin-top:10px;">
                                <li>Supported formats: .xlsx, .xls</li>
                                <li>Protected PDFs will use page numbers from Excel if provided.</li>
                                <li>Other PDFs will use page count from the document (server logic).</li>
                            </ul>
                        </div>
                    </div>

                    <div class="drop-zone" id="excelDropZone">
                        <svg class="drop-zone-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                  d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                        <div class="drop-zone-text">Upload Metadata Excel</div>
                        <div class="drop-zone-info">Drag and drop the Excel file here or use Browse</div>
                        <div class="drop-zone-info" style="margin-bottom:20px;">
                            <i class="bi bi-info-circle"></i> Supported formats: .xlsx, .xls
                        </div>
                        <button type="button" class="browse-btn" onclick="document.getElementById('excelFileInput').click()">
                            <i class="bi bi-file-earmark-excel"></i> Browse File
                        </button>
                        <input type="file" id="excelFileInput" accept=".xlsx,.xls" style="display:none;">
                    </div>

                    <div class="folder-uploaded-message" id="excelUploadedMessage">
                        <div class="folder-uploaded-icon"><i class="bi bi-check-circle-fill"></i></div>
                        <div class="folder-uploaded-title">Excel File Uploaded Successfully!</div>
                        <div class="folder-uploaded-details">
                            <strong id="uploadedExcelName">file.xlsx</strong> •
                            <span id="uploadedExcelSize">0 KB</span>
                        </div>
                        <button type="button" class="change-file-btn" onclick="changeExcelFile()">
                            <i class="bi bi-arrow-repeat"></i> Change File
                        </button>
                    </div>
                </div>

                <!-- Step 4: self validation -->
                <div class="wizard-step-content" data-step="4">
                    <div style="display:flex;flex-direction:column;height:100%;">
                        <!-- top 20% -->
                        <div style="flex:0 0 20%;display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
                            <div>
                                <div class="self-validation-title">Self Validation & Metadata Editing</div>
                                <div class="self-validation-info">
                                    Review metadata from Excel and folder. Click <strong>Edit</strong> to update, then <strong>Done</strong> to lock and continue.
                                </div>
                            </div>
                            <div style="display:flex;gap:10px;">
                                <button type="button" class="wizard-btn wizard-btn-secondary" id="editMetadataBtn">
                                    <i class="bi bi-pencil-square"></i> Edit
                                </button>
                                <button type="button" class="wizard-btn wizard-btn-success" id="doneMetadataBtn" disabled>
                                    <i class="bi bi-check2-circle"></i> Done
                                </button>
                            </div>
                        </div>
                        <!-- bottom 80% -->
                        <div style="flex:1 1 80%;min-height:0;">
                            <div class="self-validation-table-wrapper" style="height:100%;">
                                <table class="self-validation-table" id="selfValidationTable">
                                    <thead>
                                    <tr>
                                        <th style="min-width:180px;">Document Name</th>
                                        <th style="min-width:150px;">Title</th>
                                        <th style="min-width:120px;">Product Code</th>
                                        <th style="min-width:100px;">Edition</th>
                                        <th style="min-width:120px;">Publish Month</th>
                                        <th style="min-width:100px;">Publish Year</th>
                                        <th style="min-width:100px;">No of Pages</th>
                                        <th style="min-width:160px;">Notes</th>
                                        <th style="min-width:180px;">Tags (multi)</th>
                                        <th style="min-width:200px;">Classifications (multi)</th>
                                    </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                            <div class="self-validation-info">
                                Tags and Classifications support multiple values using dropdown with checkboxes.
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 5: validation -->
                <div class="wizard-step-content" data-step="5">
                    <div class="validation-results">
                        <div class="validation-header">
                            <div class="validation-title">Validation Results</div>
                            <div class="validation-status" id="validationStatus">Validating...</div>
                        </div>
                        <div class="validation-stats">
                            <div class="stat-card total">
                                <div class="stat-number" id="totalDocuments">0</div>
                                <div class="stat-label">Total Documents</div>
                            </div>
                            <div class="stat-card valid">
                                <div class="stat-number" id="validDocuments">0</div>
                                <div class="stat-label">Valid</div>
                            </div>
                            <div class="stat-card warnings">
                                <div class="stat-number" id="warningCount">0</div>
                                <div class="stat-label">Warnings</div>
                            </div>
                            <div class="stat-card errors">
                                <div class="stat-number" id="errorCount">0</div>
                                <div class="stat-label">Errors</div>
                            </div>
                        </div>
                        <div class="validation-issues" id="validationIssues"></div>
                        <div class="validation-error-actions" id="validationErrorActions">
                            <h4><i class="bi bi-exclamation-triangle-fill"></i>Validation Errors Found</h4>
                            <p>You have the following options:</p>
                            <div class="error-action-buttons">
                                <button type="button" class="error-action-btn upload-valid" id="uploadValidBtn">
                                    <i class="bi bi-cloud-upload"></i> Upload Valid Documents Only
                                </button>
                                <button type="button" class="error-action-btn reupload-folder" id="reuploadFolderBtn">
                                    <i class="bi bi-folder2-open"></i> Re-upload Folder
                                </button>
                                <button type="button" class="error-action-btn reupload-excel" id="reuploadExcelBtn">
                                    <i class="bi bi-file-earmark-excel"></i> Re-upload Metadata Excel
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 6: upload -->
                <div class="wizard-step-content" data-step="6">
                    <div class="progress-container">
                        <div class="progress-header">
                            <div class="progress-title">Uploading Documents...</div>
                            <div class="progress-subtitle">Please wait while we process your documents</div>
                        </div>
                        <div class="progress-bar-container">
                            <div class="progress-bar-wrapper">
                                <div class="progress-bar-fill" id="progressBar" style="width:0%">0%</div>
                            </div>
                            <div class="progress-text" id="progressText">Processing 0 of 0 documents...</div>
                        </div>
                        <div class="upload-log" id="uploadLog"></div>
                    </div>
                </div>
            </div>

            <div class="wizard-navigation" id="wizardNavigation">
                <div>
                    <button type="button" class="wizard-btn wizard-btn-secondary" id="prevBtn" style="display:none;">
                        <i class="bi bi-arrow-left"></i> Previous
                    </button>
                </div>
                <div style="display:flex;gap:12px;">
                    <button type="button" class="wizard-btn wizard-btn-secondary" id="cancelBtn">
                        <i class="bi bi-x-circle"></i> Cancel
                    </button>
                    <button type="button" class="wizard-btn wizard-btn-primary" id="nextBtn">
                        Next <i class="bi bi-arrow-right"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Unsaved changes modal -->
        <div class="custom-modal-overlay" id="confirmationModal">
            <div class="custom-modal">
                <div class="modal-header-custom modal-header-danger">
                    <div class="modal-icon">
                        <i class="bi bi-exclamation-triangle"></i>
                    </div>
                    <div class="modal-title-custom">
                        <h3>Unsaved Changes</h3>
                        <p>You have unsaved changes that will be lost</p>
                    </div>
                    <button type="button" class="modal-close-btn" onclick="closeConfirmationModal()">
                        <i class="bi bi-x"></i>
                    </button>
                </div>
                <div class="modal-body-custom">
                    <p>Are you sure you want to leave this page? All your progress will be lost if you continue.</p>
                </div>
                <div class="modal-footer-custom">
                    <button type="button" class="modal-btn modal-btn-secondary" onclick="closeConfirmationModal()">
                        Continue Editing
                    </button>
                    <button type="button" class="modal-btn modal-btn-danger" id="confirmCancelBtn">
                        Yes, Leave Page
                    </button>
                </div>
            </div>
        </div>

        <!-- FEATURE 1: Updated Upload Valid Confirmation Modal with Skipped Documents List -->
        <!-- Replace the existing uploadValidConfirmModal div with this -->

        <div class="custom-modal-overlay" id="uploadValidConfirmModal">
            <div class="custom-modal" style="max-width:700px;">
                <div class="modal-header-custom modal-header-warning">
                    <div class="modal-icon">
                        <i class="bi bi-exclamation-triangle"></i>
                    </div>
                    <div class="modal-title-custom">
                        <h3>Upload Valid Documents Only</h3>
                        <p>Some documents have validation errors</p>
                    </div>
                    <button type="button" class="modal-close-btn" onclick="closeUploadValidConfirmModal()">
                        <i class="bi bi-x"></i>
                    </button>
                </div>
                <div class="modal-body-custom">
                    <p><strong>You are about to upload only the valid documents.</strong></p>
                    <p>
                        <span id="validDocsCount" style="color:#10b981;font-weight:600;">0</span> documents will be uploaded successfully.<br>
                        <span id="errorDocsCount" style="color:#ef4444;font-weight:600;">0</span> documents with errors will be skipped.
                    </p>

                    <!-- FEATURE 1: Skipped Documents List -->
                    <div style="margin-top:20px;">
                        <p style="font-weight:600;color:#1a2332;margin-bottom:10px;">
                            <i class="bi bi-exclamation-circle-fill" style="color:#ef4444;"></i>
                            Documents that will be skipped:
                        </p>
                        <div class="protected-files-list" id="skippedDocumentsList" style="max-height:250px;">
                            <!-- Dynamically populated by JavaScript -->
                        </div>
                    </div>

                    <p style="margin-top:15px;">Do you want to proceed with uploading only the valid documents?</p>
                    <p style="font-size:13px;color:#6b7280;margin-top:10px;">
                        <i class="bi bi-info-circle"></i> You can fix the errors and upload the remaining documents later.
                    </p>
                </div>
                <div class="modal-footer-custom">
                    <button type="button" class="modal-btn modal-btn-secondary" onclick="closeUploadValidConfirmModal()">
                        Cancel
                    </button>
                    <button type="button" class="modal-btn modal-btn-warning" id="confirmUploadValidBtn">
                        <i class="bi bi-cloud-upload"></i> Yes, Upload Valid Documents
                    </button>
                </div>
            </div>
        </div>

        <!-- PDF protection modal -->
        <div class="custom-modal-overlay" id="pdfProtectionModal">
            <div class="custom-modal">
                <div class="modal-header-custom modal-header-warning">
                    <div class="modal-icon">
                        <i class="bi bi-shield-lock"></i>
                    </div>
                    <div class="modal-title-custom">
                        <h3>Protected PDFs Detected</h3>
                        <p>Some documents have restrictions</p>
                    </div>
                    <button type="button" class="modal-close-btn" onclick="closePdfProtectionModal()">
                        <i class="bi bi-x"></i>
                    </button>
                </div>
                <div class="modal-body-custom">
                    <p><strong><span id="protectedFileCount">0</span> PDF file(s) have the following restrictions:</strong></p>
                    <div class="protected-files-list" id="protectedFilesList"></div>
                    <p style="margin-top:15px;"><strong>How do you want to proceed?</strong></p>
                    <ul>
                        <li><strong>Remove protected files and continue</strong>: Protected PDFs will be excluded from this upload.</li>
                        <li><strong>Continue anyway</strong>: Protected PDFs will be kept, and page numbers must come from metadata.</li>
                        <li><strong>Cancel &amp; Select Again</strong>: Go back and choose another folder.</li>
                    </ul>
                </div>
                <div class="modal-footer-custom">
                    <button type="button" class="modal-btn modal-btn-secondary" onclick="cancelProtectedPdfs()">
                        Cancel &amp; Select Again
                    </button>
                    <button type="button" class="modal-btn modal-btn-warning" id="removeProtectedAndContinueBtn">
                        <i class="bi bi-slash-circle"></i> Remove Protected &amp; Continue
                    </button>
                    <button type="button" class="modal-btn modal-btn-warning" id="forceUploadProtectedBtn">
                        <i class="bi bi-shield-exclamation"></i> Continue Anyway
                    </button>
                </div>
            </div>
        </div>

    </div>
</div>

<script src="/js/bootstrap.bundle.min.js"></script>
<div th:replace="~{common/navbar :: navbar-js}"></div>
<!-- paste the JS block I gave in the previous message here -->


<script>
    let currentStep = 1;
  let formChanged = false;
  let pdfFiles = [];
  let protectedPdfFiles = [];
  let excelFile = null;
  let validationResult = null;
  let uploadStartTime = null;
  let isSubmitting = false;
  let navigationConfirmed = false;
  let pendingNavigationUrl = null;
  let isDownloadingTemplate = false;
  let selectedPdfIndices = new Set();
  let lastVisitedUrl = document.referrer || '';

  // Step 4 metadata confirmation - THIS IS THE SOURCE OF TRUTH AFTER EDITING
  let selfValidationData = [];
  let isEditingMetadata = false;

  // FEATURE 2: Store backend tags and classifications
  let backendTags = [];
  let backendClassifications = [];

  // FEATURE 3: Month options
  const MONTH_OPTIONS = [
      { value: '01', label: '01 (Jan)' },
      { value: '02', label: '02 (Feb)' },
      { value: '03', label: '03 (Mar)' },
      { value: '04', label: '04 (Apr)' },
      { value: '05', label: '05 (May)' },
      { value: '06', label: '06 (Jun)' },
      { value: '07', label: '07 (Jul)' },
      { value: '08', label: '08 (Aug)' },
      { value: '09', label: '09 (Sep)' },
      { value: '10', label: '10 (Oct)' },
      { value: '11', label: '11 (Nov)' },
      { value: '12', label: '12 (Dec)' }
  ];

  document.addEventListener('DOMContentLoaded', function () {
      if (typeof pdfjsLib !== 'undefined') {
          pdfjsLib.GlobalWorkerOptions.workerSrc = '/pdfjs/pdf.worker.js';
      }
      const folderInput = document.getElementById('folderInput');
      if (!('webkitdirectory' in folderInput)) {
          showCustomAlert('Your browser may not fully support folder selection. Please try Chrome, Edge, or another modern browser.', 'warning');
      }

      // FEATURE 2: Fetch tags and classifications from backend on page load
      fetchTagsAndClassifications();
  });

  /* ===================== FEATURE 2: FETCH TAGS & CLASSIFICATIONS ===================== */

  async function fetchTagsAndClassifications() {
      try {
          // Fetch tags
          const tagsResponse = await fetch('/api/tags/all');
          if (tagsResponse.ok) {
              backendTags = await tagsResponse.json();
              console.log('Loaded tags from backend:', backendTags);
          }

          // Fetch classifications
          const classResponse = await fetch('/api/classifications/all');
          if (classResponse.ok) {
              backendClassifications = await classResponse.json();
              console.log('Loaded classifications from backend:', backendClassifications);
          }
      } catch (error) {
          console.error('Error fetching tags/classifications:', error);
          // Fallback to empty arrays
          backendTags = [];
          backendClassifications = [];
      }
  }

  /* ===================== FILENAME UTILITIES ===================== */

  function extractFilenameFromPath(pathOrFilename) {
      if (!pathOrFilename) return '';
      const parts = pathOrFilename.split(/[/\\]/);
      return parts[parts.length - 1];
  }

  function getFileActualName(file) {
      if (!file) return '';
      if (file.webkitRelativePath) {
          return extractFilenameFromPath(file.webkitRelativePath);
      }
      return file.name;
  }

  /* ===================== WIZARD NAV ===================== */

  function updateWizardStep(step) {
      document.querySelectorAll('.wizard-step-content').forEach(c => c.classList.remove('active'));
      const currentContent = document.querySelector(`.wizard-step-content[data-step="${step}"]`);
      if (currentContent) currentContent.classList.add('active');

      document.querySelectorAll('.wizard-step').forEach(el => {
          const sn = parseInt(el.getAttribute('data-step'));
          el.classList.remove('active','completed');
          if (sn < step) el.classList.add('completed');
          else if (sn === step) el.classList.add('active');
      });

      const prevBtn = document.getElementById('prevBtn');
      const nextBtn = document.getElementById('nextBtn');
      const nav = document.getElementById('wizardNavigation');

      if (step === 1) {
          prevBtn.style.display = 'none';
          nextBtn.style.display = 'inline-flex';
          nextBtn.className = 'wizard-btn wizard-btn-primary';
          nextBtn.innerHTML = 'Next <i class="bi bi-arrow-right"></i>';
          nav.style.display = 'flex';
      } else if (step === 2) {
          prevBtn.style.display = 'inline-flex';
          nextBtn.style.display = 'inline-flex';
          nextBtn.className = 'wizard-btn wizard-btn-primary';
          nextBtn.innerHTML = 'Next <i class="bi bi-arrow-right"></i>';
          nav.style.display = 'flex';
      } else if (step === 3) {
          prevBtn.style.display = 'inline-flex';
          nextBtn.style.display = 'inline-flex';
          nextBtn.className = 'wizard-btn wizard-btn-primary';
          nextBtn.innerHTML = 'Go to Confirmation <i class="bi bi-arrow-right"></i>';
          nav.style.display = 'flex';
      } else if (step === 4) {
          prevBtn.style.display = 'inline-flex';
          nextBtn.style.display = 'inline-flex';
          nextBtn.className = 'wizard-btn wizard-btn-primary';
          nextBtn.innerHTML = 'Validate <i class="bi bi-check-square"></i>';
          nav.style.display = 'flex';
          parseExcelAndBuildTable();
      } else if (step === 5) {
          prevBtn.style.display = 'inline-flex';
          nextBtn.style.display = 'inline-flex';
          nextBtn.className = 'wizard-btn wizard-btn-primary';
          nextBtn.innerHTML = 'Validate <i class="bi bi-check-square"></i>';
          nav.style.display = 'flex';
      } else if (step === 6) {
          nav.style.display = 'none';
      }
      currentStep = step;
  }

  function updateStep5Navigation(hasErrors) {
      const prevBtn = document.getElementById('prevBtn');
      const nextBtn = document.getElementById('nextBtn');
      prevBtn.style.display = 'inline-flex';
      nextBtn.style.display = 'inline-flex';
      if (hasErrors) {
          nextBtn.className = 'wizard-btn wizard-btn-warning';
          nextBtn.innerHTML = '<i class="bi bi-cloud-upload"></i> Upload Valid Documents';
      } else {
          nextBtn.className = 'wizard-btn wizard-btn-success';
          nextBtn.innerHTML = '<i class="bi bi-cloud-upload"></i> Upload All';
      }
  }

  document.getElementById('nextBtn').addEventListener('click', async function () {
      if (currentStep === 1) {
          if (pdfFiles.length === 0) {
              showCustomAlert('Please select a folder with PDF files before proceeding.');
              return;
          }
          if (selectedPdfIndices.size === 0) {
              showCustomAlert('Please keep at least one document checked before proceeding.');
              return;
          }
          const o = formChanged; formChanged = false;
          updateWizardStep(2); formChanged = o;
      } else if (currentStep === 2) {
          const o = formChanged; formChanged = false;
          updateWizardStep(3); formChanged = o;
      } else if (currentStep === 3) {
          if (!excelFile) {
              showCustomAlert('Please upload the metadata Excel file before proceeding.');
              return;
          }
          const o = formChanged; formChanged = false;
          updateWizardStep(4); formChanged = o;
      } else if (currentStep === 4) {
          if (isEditingMetadata) {
              showCustomAlert('Please click Done to finish editing before going to next step.', 'warning');
              return;
          }
          captureSelfValidationDataFromTable();
          console.log('=== SENDING TO VALIDATION (FROM STEP 4) ===');
          console.log('selfValidationData:', JSON.stringify(selfValidationData, null, 2));
          const o = formChanged; formChanged = false;
          await validateFiles(); formChanged = o;
      } else if (currentStep === 5) {
          if (validationResult && validationResult.errors && validationResult.errors.length > 0) {
              showUploadValidConfirmation();
          } else {
              const o = formChanged; formChanged = false;
              await startUpload(false); formChanged = o;
          }
      }
  });

  document.getElementById('prevBtn').addEventListener('click', function () {
      if (currentStep > 1 && currentStep <= 6) {
          const o = formChanged; formChanged = false;
          updateWizardStep(currentStep - 1); formChanged = o;
      }
  });

  /* ===================== STEP 4: EXCEL PARSING & EDITING ===================== */

  function normalizeFilename(filename) {
      if (!filename) return '';
      const justFilename = extractFilenameFromPath(filename);
      return justFilename
          .toLowerCase()
          .replace(/\.pdf$/i, '')
          .replace(/[_\s-]+/g, '')
          .trim();
  }

  function getColumnValue(row, possibleNames) {
      for (let name of possibleNames) {
          if (row[name] !== undefined && row[name] !== null && row[name] !== '') {
              return row[name].toString().trim();
          }
          const keys = Object.keys(row);
          const matchedKey = keys.find(k => k.toLowerCase() === name.toLowerCase());
          if (matchedKey && row[matchedKey] !== undefined && row[matchedKey] !== null && row[matchedKey] !== '') {
              return row[matchedKey].toString().trim();
          }
      }
      return '';
  }

  async function parseExcelAndBuildTable() {
    if (!excelFile) {
        showCustomAlert('No Excel file uploaded.', 'error');
        return;
    }

    const loadingAlert = showCustomAlert('Reading Excel file...', 'info', false);

    try {
        const arrayBuffer = await excelFile.arrayBuffer();
        const workbook = XLSX.read(arrayBuffer, { type: 'array' });
        const firstSheetName = workbook.SheetNames[0];
        const worksheet = workbook.Sheets[firstSheetName];
        const jsonData = XLSX.utils.sheet_to_json(worksheet, { defval: '' });

        if (loadingAlert) loadingAlert.remove();

        console.log('Excel parsed successfully. Rows:', jsonData.length);

        if (!jsonData || jsonData.length === 0) {
            showCustomAlert('Excel file is empty or has no data.', 'warning');
            buildEmptySelfValidationTable();
            return;
        }

        const indices = Array.from(selectedPdfIndices);
        selfValidationData = [];

        let matchCount = 0;

        indices.forEach(idx => {
            const file = pdfFiles[idx];
            const fileName = getFileActualName(file);

            console.log(`Processing file ${idx}: actualName="${fileName}"`);

            let excelRow = jsonData.find(row => {
                const rowFileName = getColumnValue(row, ['Filename', 'Document Name', 'FileName', 'File Name', 'document_name', 'filename', 'file_name', 'DocumentName']);
                const extractedFileName = extractFilenameFromPath(rowFileName);
                const match = extractedFileName.toLowerCase() === fileName.toLowerCase();
                if (match) console.log(`  ✓ Exact match found: "${extractedFileName}"`);
                return match;
            });

            if (!excelRow) {
                excelRow = jsonData.find(row => {
                    const rowFileName = getColumnValue(row, ['Filename', 'Document Name', 'FileName', 'File Name', 'document_name', 'filename', 'file_name', 'DocumentName']);
                    const extractedFileName = extractFilenameFromPath(rowFileName);
                    const normalizedExcelName = normalizeFilename(extractedFileName);
                    const normalizedPdfName = normalizeFilename(fileName);
                    const match = normalizedExcelName === normalizedPdfName;
                    if (match) console.log(`  ✓ Normalized match found: "${extractedFileName}"`);
                    return match;
                });
            }

            if (excelRow) {
                matchCount++;
            } else {
                console.log(`  ✗ No match found for "${fileName}"`);
            }

            let tags = [];
            let classifications = [];

            if (excelRow) {
                const tagsValue = getColumnValue(excelRow, ['Tags', 'tags', 'TAG', 'tag', 'Tags (comma-separated)']);
                if (tagsValue) {
                    if (typeof tagsValue === 'string') {
                        tags = tagsValue.split(',').map(t => normalizeTag(t)).filter(t => t);
                    } else if (Array.isArray(tagsValue)) {
                        tags = tagsValue.map(t => normalizeTag(t.toString())).filter(t => t);
                    }
                }

                const classValue = getColumnValue(excelRow, ['Classifications', 'Classification', 'classifications', 'classification', 'CLASSIFICATION', 'Classifications (comma-separated)']);
                if (classValue) {
                    if (typeof classValue === 'string') {
                        classifications = classValue.split(',').map(c => c.trim()).filter(c => c);
                    } else if (Array.isArray(classValue)) {
                        classifications = classValue.map(c => c.toString().trim()).filter(c => c);
                    }
                }
            }

            // FIXED: Parse publish month from Excel
            let publishMonth = '';
            if (excelRow) {
                publishMonth = getColumnValue(excelRow, ['Publish Month', 'PublishMonth', 'publish_month', 'PUBLISH_MONTH', 'Month', 'month']);

                // Handle format "01 (Jan)" or "01" or "1"
                if (publishMonth) {
                    publishMonth = publishMonth.trim();

                    // Extract just the number if format is "01 (Jan)"
                    if (publishMonth.includes('(')) {
                        publishMonth = publishMonth.substring(0, publishMonth.indexOf('(')).trim();
                    }

                    // Ensure it's always 2 digits
                    if (publishMonth.length === 1 && !isNaN(publishMonth)) {
                        publishMonth = '0' + publishMonth;
                    }

                    console.log(`  Parsed publishMonth: "${publishMonth}"`);
                }
            }

            const metadata = {
                fileIndex: idx,
                fileName: fileName,
                title: excelRow ? getColumnValue(excelRow, ['Title', 'title', 'TITLE']) : '',
                productCode: excelRow ? getColumnValue(excelRow, ['Product Code', 'ProductCode', 'product_code', 'PRODUCT_CODE', 'Code', 'code']) : '',
                edition: excelRow ? getColumnValue(excelRow, ['Edition', 'edition', 'EDITION', 'Version', 'version']) : '',
                publishMonth: publishMonth,  // FIXED: Now properly parsed
                publishYear: excelRow ? getColumnValue(excelRow, ['Publish Year', 'PublishYear', 'publish_year', 'PUBLISH_YEAR', 'Year', 'year']) : '',
                noOfPages: excelRow ? getColumnValue(excelRow, ['No of Pages', 'NoOfPages', 'no_of_pages', 'Pages', 'pages', 'PAGE_COUNT', 'PageCount']) : '',
                notes: excelRow ? getColumnValue(excelRow, ['Notes', 'notes', 'NOTES', 'Note', 'note', 'Description', 'description']) : '',
                tags: tags,
                classifications: classifications
            };

            selfValidationData.push(metadata);
        });

        buildSelfValidationTable();

        if (matchCount === 0) {
            showCustomAlert('Warning: No filenames matched! Check the console (F12) for details.', 'warning');
        } else if (matchCount < indices.length) {
            showCustomAlert(`Partial match: ${matchCount} of ${indices.length} documents matched.`, 'warning');
        } else {
            showCustomAlert(`Success! All ${matchCount} documents matched with Excel data.`, 'success');
        }

    } catch (error) {
        if (loadingAlert) loadingAlert.remove();
        console.error('Error parsing Excel:', error);
        showCustomAlert('Failed to parse Excel file: ' + error.message, 'error');
        buildEmptySelfValidationTable();
    }
}

  // FEATURE 6: Normalize tag - remove spaces, convert to lowercase
  function normalizeTag(tag) {
      if (!tag) return '';
      return tag.trim().replace(/\s+/g, '').toLowerCase();
  }

  function buildEmptySelfValidationTable() {
      const indices = Array.from(selectedPdfIndices);
      selfValidationData = indices.map(idx => ({
          fileIndex: idx,
          fileName: getFileActualName(pdfFiles[idx]),
          title: '',
          productCode: '',
          edition: '',
          publishMonth: '',
          publishYear: '',
          noOfPages: '',
          notes: '',
          tags: [],
          classifications: []
      }));
      buildSelfValidationTable();
  }

  document.getElementById('editMetadataBtn').addEventListener('click', function () {
      isEditingMetadata = true;
      updateSelfValidationEditState();
      showCustomAlert('Editing enabled. Make your changes and click Done when finished.', 'info');
  });

  document.getElementById('doneMetadataBtn').addEventListener('click', function () {
      captureSelfValidationDataFromTable();
      isEditingMetadata = false;
      updateSelfValidationEditState();
      formChanged = true;
      console.log('=== DATA CAPTURED AFTER EDITING (DONE CLICKED) ===');
      console.log('selfValidationData:', JSON.stringify(selfValidationData, null, 2));
      showCustomAlert('Metadata confirmed. You can proceed to validation.', 'success');
  });

  function updateSelfValidationEditState() {
      const editBtn = document.getElementById('editMetadataBtn');
      const doneBtn = document.getElementById('doneMetadataBtn');
      const nextBtn = document.getElementById('nextBtn');
      const inputs = document.querySelectorAll('#selfValidationTable tbody input, #selfValidationTable tbody select');

      if (isEditingMetadata) {
          editBtn.disabled = true;
          doneBtn.disabled = false;
          nextBtn.disabled = true;
          inputs.forEach(i => {
              if (i.dataset.locked === 'true') return;
              if (i.tagName === 'SELECT') {
                  i.disabled = false;
              } else {
                  i.readOnly = false;
              }
          });
      } else {
          editBtn.disabled = false;
          doneBtn.disabled = false;
          nextBtn.disabled = false;
          inputs.forEach(i => {
              if (i.tagName === 'SELECT') {
                  i.disabled = true;
              } else {
                  i.readOnly = true;
              }
          });
      }
  }

  function buildSelfValidationTable() {
      const tbody = document.querySelector('#selfValidationTable tbody');
      if (!tbody) return;
      tbody.innerHTML = '';

      if (selectedPdfIndices.size === 0) {
          tbody.innerHTML = '<tr><td colspan="10" style="text-align:center;color:#6b7280;padding:16px;">No documents selected.</td></tr>';
          return;
      }

      if (selfValidationData.length === 0) {
          tbody.innerHTML = '<tr><td colspan="10" style="text-align:center;color:#6b7280;padding:16px;">No metadata loaded. Please check Excel file.</td></tr>';
          return;
      }

      selfValidationData.forEach((meta, index) => {
          const tagsArr = meta.tags || [];
          const classArr = meta.classifications || [];

          // FEATURE 2: Display count if multiple selected
          const tagsDisplay = tagsArr.length === 0 ? 'Select tags...' :
                             tagsArr.length === 1 ? tagsArr[0] :
                             `${tagsArr.length} selected`;
          const classDisplay = classArr.length === 0 ? 'Select classifications...' :
                              classArr.length === 1 ? classArr[0] :
                              `${classArr.length} selected`;

          // FEATURE 3: Build month dropdown options
          const monthOptions = MONTH_OPTIONS.map(opt =>
              `<option value="${opt.value}" ${meta.publishMonth === opt.value ? 'selected' : ''}>${opt.label}</option>`
          ).join('');

          const row = document.createElement('tr');
          row.dataset.fileIndex = meta.fileIndex;
          row.innerHTML = `
              <td><input type="text" value="${escapeHtml(meta.fileName || '')}" readonly data-locked="true"></td>
              <td><input type="text" value="${escapeHtml(meta.title || '')}"></td>
              <td><input type="text" value="${escapeHtml(meta.productCode || '')}"></td>
              <td><input type="text" value="${escapeHtml(meta.edition || '')}"></td>
              <td>
                  <select class="form-select" style="font-size:12px;padding:3px 5px;" disabled>
                      <option value="">Select...</option>
                      ${monthOptions}
                  </select>
              </td>
              <td><input type="number" min="1900" value="${escapeHtml(meta.publishYear || '')}"></td>
              <td><input type="number" min="1" value="${escapeHtml(meta.noOfPages || '')}"></td>
              <td><input type="text" value="${escapeHtml(meta.notes || '')}"></td>
              <td>
                  <div class="multi-select-container" data-type="tags" data-selected='${JSON.stringify(tagsArr)}'>
                      <div class="multi-select-display">
                          <span>${escapeHtml(tagsDisplay)}</span>
                          <i class="bi bi-chevron-down"></i>
                      </div>
                  </div>
              </td>
              <td>
                  <div class="multi-select-container" data-type="classifications" data-selected='${JSON.stringify(classArr)}'>
                      <div class="multi-select-display">
                          <span>${escapeHtml(classDisplay)}</span>
                          <i class="bi bi-chevron-down"></i>
                      </div>
                  </div>
              </td>
          `;
          tbody.appendChild(row);
      });

      document.querySelectorAll('#selfValidationTable tbody input').forEach(i => i.readOnly = true);
      document.querySelectorAll('#selfValidationTable tbody select').forEach(s => s.disabled = true);
      wireMultiSelectEvents();
  }

  function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
  }

  function wireMultiSelectEvents() {
      document.querySelectorAll('#selfValidationTable .multi-select-display').forEach(display => {
          display.onclick = function (e) {
              if (!isEditingMetadata) return;
              e.stopPropagation();
              const container = this.closest('.multi-select-container');
              toggleMultiSelectPanel(container);
          };
      });
  }

  document.addEventListener('click', () => {
      document.querySelectorAll('.multi-select-panel').forEach(p => p.remove());
  });

  function toggleMultiSelectPanel(container) {
      const existing = container.querySelector('.multi-select-panel');
      if (existing) { existing.remove(); return; }

      const type = container.dataset.type;
      // FEATURE 2: Use backend data
      const allItems = type === 'tags' ? backendTags.map(t => t.tagName || t) :
                                         backendClassifications.map(c => c.classificationName || c);
      const selected = JSON.parse(container.dataset.selected || '[]');

      const panel = document.createElement('div');
      panel.className = 'multi-select-panel';

      const searchDiv = document.createElement('div');
      searchDiv.className = 'multi-select-search';
      searchDiv.innerHTML = '<input type="text" placeholder="Search...">';
      panel.appendChild(searchDiv);

      const listDiv = document.createElement('div');
      allItems.forEach(item => {
          const opt = document.createElement('div');
          opt.className = 'multi-select-option';
          const isSelected = selected.includes(item);
          opt.innerHTML = `<input type="checkbox" ${isSelected?'checked':''}><span>${item}</span>`;
          opt.onclick = function (e) {
              e.stopPropagation();
              const cb = this.querySelector('input[type="checkbox"]');
              cb.checked = !cb.checked;
              const label = this.querySelector('span').textContent;
              const arr = JSON.parse(container.dataset.selected || '[]');
              if (cb.checked && !arr.includes(label)) arr.push(label);
              if (!cb.checked) {
                  const i = arr.indexOf(label); if (i>=0) arr.splice(i,1);
              }
              container.dataset.selected = JSON.stringify(arr);

              // FEATURE 2: Update display with count
              const dispSpan = container.querySelector('.multi-select-display span');
              if (arr.length === 0) {
                  dispSpan.textContent = type === 'tags' ? 'Select tags...' : 'Select classifications...';
              } else if (arr.length === 1) {
                  dispSpan.textContent = arr[0];
              } else {
                  dispSpan.textContent = `${arr.length} selected`;
              }
          };
          listDiv.appendChild(opt);
      });
      panel.appendChild(listDiv);

      const footer = document.createElement('div');
      footer.className = 'multi-select-footer';
      footer.textContent = `${allItems.length} ${type} available. Multiple selection allowed.`;
      panel.appendChild(footer);

      const searchInput = searchDiv.querySelector('input');
      searchInput.oninput = function () {
          const term = this.value.toLowerCase();
          listDiv.querySelectorAll('.multi-select-option').forEach(o => {
              const txt = o.querySelector('span').textContent.toLowerCase();
              o.style.display = txt.includes(term) ? 'flex' : 'none';
          });
      };

      container.appendChild(panel);
  }

  function captureSelfValidationDataFromTable() {
    const rows = document.querySelectorAll('#selfValidationTable tbody tr');
    const result = [];
    rows.forEach(row => {
        const idx = parseInt(row.dataset.fileIndex);
        const cells = row.querySelectorAll('td');
        if (cells.length < 10) return;

        // Helper to get input value
        const getVal = i => cells[i].querySelector('input')?.value || '';

        // FIXED: Helper to get select value (for month dropdown)
        const getSelectVal = i => {
            const select = cells[i].querySelector('select');
            if (!select) return '';
            let value = select.value || '';

            // Extract just the number part if format is "01 (Jan)"
            if (value && value.includes('(')) {
                value = value.substring(0, value.indexOf('(')).trim();
            }

            // Ensure it's always 2 digits
            if (value && value.length === 1) {
                value = '0' + value;
            }

            console.log(`Captured month from row ${idx}: "${value}"`);
            return value;
        };

        const fileName = getVal(0);
        const title = getVal(1);
        const productCode = getVal(2);
        const edition = getVal(3);
        const publishMonth = getSelectVal(4);  // FIXED: Get from dropdown with proper parsing
        const publishYear = getVal(5);
        const noOfPages = getVal(6);
        const notes = getVal(7);

        const tagsContainer = cells[8].querySelector('.multi-select-container');
        const classContainer = cells[9].querySelector('.multi-select-container');
        const tags = JSON.parse(tagsContainer?.dataset.selected || '[]');
        const classifications = JSON.parse(classContainer?.dataset.selected || '[]');

        result.push({
            fileIndex: idx,
            fileName: fileName,
            title,
            productCode,
            edition,
            publishMonth,  // Now correctly captured
            publishYear,
            noOfPages,
            notes,
            tags,
            classifications
        });
    });
    selfValidationData = result;
    console.log('=== CAPTURED FROM TABLE ===');
    console.log('Captured edited data:', JSON.stringify(selfValidationData, null, 2));
}

  /* ===================== STEP 1: FOLDER & PROTECTION ===================== */

  const folderInput = document.getElementById('folderInput');
  const folderUploadedMessage = document.getElementById('folderUploadedMessage');
  const dropZone = document.getElementById('dropZone');

  folderInput.addEventListener('change', async function (e) {
      const files = Array.from(e.target.files);
      if (files.length > 0) await handleFolderSelection(files);
  });

  async function handleFolderSelection(files) {
      if (!files || files.length === 0) {
          showCustomAlert('No files selected. Please select a folder.');
          return;
      }
      const pdfFilesTemp = files.filter(f => {
          const actualName = getFileActualName(f);
          return actualName.toLowerCase().endsWith('.pdf');
      });

      if (pdfFilesTemp.length === 0) {
          showCustomAlert('No PDF files found in the selected folder. Please select a folder containing PDF files.');
          return;
      }

      console.log(`Found ${pdfFilesTemp.length} PDF files in folder`);
      await checkPdfProtection(pdfFilesTemp);
  }

  async function checkPdfProtection(files) {
      protectedPdfFiles = [];
      const protectedFilesData = [];
      const loadingAlert = showCustomAlert('Checking PDF files for restrictions... This may take a moment.', 'info', false);
      let checkedCount = 0;

      for (let file of files) {
          try {
              checkedCount++;
              if (loadingAlert && loadingAlert.querySelector('span')) {
                  loadingAlert.querySelector('span').textContent =
                      `Checking PDF files (${checkedCount}/${files.length})...`;
              }
              const arrayBuffer = await file.arrayBuffer();
              const loadingTask = pdfjsLib.getDocument({data: arrayBuffer});
              try {
                  const pdf = await loadingTask.promise;
                  const restrictions = [];
                  if (pdf.isEncrypted) restrictions.push('Password Protected');
                  try {
                      const permissions = await pdf.getPermissions();
                      if (permissions) {
                          if (permissions.includes(4) === false) restrictions.push('Print Restricted');
                          if (permissions.includes(16) === false) restrictions.push('Copy Restricted');
                          if (permissions.includes(8) === false) restrictions.push('Modification Restricted');
                      }
                  } catch (permError) {}
                  if (restrictions.length > 0) {
                      protectedPdfFiles.push(file);
                      protectedFilesData.push({name: getFileActualName(file), restrictions});
                  }
              } catch (pdfError) {
                  if (pdfError.name === 'PasswordException') {
                      protectedPdfFiles.push(file);
                      protectedFilesData.push({name: getFileActualName(file), restrictions:['Password Protected']});
                  }
              }
          } catch (err) {
              console.error('Error checking PDF:', getFileActualName(file), err);
          }
      }

      if (loadingAlert) {
          loadingAlert.style.animation = 'slideOutRight 0.3s ease';
          setTimeout(() => loadingAlert.remove(), 300);
      }

      if (protectedFilesData.length > 0) {
          showProtectionWarning(files, protectedFilesData);
      } else {
          await proceedWithFolderSelection(files);
      }
  }

  function showProtectionWarning(allFiles, protectedFilesData) {
      const list = document.getElementById('protectedFilesList');
      list.innerHTML = '';
      document.getElementById('protectedFileCount').textContent = protectedFilesData.length;
      protectedFilesData.forEach(f => {
          const item = document.createElement('div');
          item.className = 'protected-file-item';
          const rhtml = f.restrictions.map(r => `<span><i class="bi bi-exclamation-triangle"></i> ${r}</span>`).join('');
          item.innerHTML = `
              <div class="protected-file-name"><i class="bi bi-file-earmark-pdf"></i> ${f.name}</div>
              <div class="protected-file-issues">${rhtml}</div>
          `;
          list.appendChild(item);
      });
      document.getElementById('pdfProtectionModal').classList.add('show');
      window.tempAllFiles = allFiles;
  }

  function closePdfProtectionModal() {
      document.getElementById('pdfProtectionModal').classList.remove('show');
  }

  function cancelProtectedPdfs() {
      folderInput.value = '';
      pdfFiles = [];
      protectedPdfFiles = [];
      selectedPdfIndices.clear();
      folderUploadedMessage.classList.remove('show');
      dropZone.style.display = 'block';
      closePdfProtectionModal();
      formChanged = false;
      selfValidationData = [];
  }

  document.getElementById('removeProtectedAndContinueBtn').addEventListener('click', async function(){
      closePdfProtectionModal();
      const allFiles = window.tempAllFiles || [];
      const filtered = allFiles.filter(f => !protectedPdfFiles.includes(f));
      await proceedWithFolderSelection(filtered);
  });

  document.getElementById('forceUploadProtectedBtn').addEventListener('click', async function(){
      closePdfProtectionModal();
      await proceedWithFolderSelection(window.tempAllFiles || []);
  });

  async function proceedWithFolderSelection(files) {
      pdfFiles = files;
      selectedPdfIndices = new Set(pdfFiles.map((_,i)=>i));
      let totalSize = 0;
      pdfFiles.forEach(f => totalSize += f.size);
      document.getElementById('uploadedFileCount').textContent = pdfFiles.length + ' PDF files';
      document.getElementById('uploadedFileSize').textContent = formatFileSize(totalSize);
      folderUploadedMessage.classList.add('show');
      dropZone.style.display = 'none';
      displayFileList();
      formChanged = true;
      selfValidationData = [];
      showCustomAlert(`Successfully loaded ${pdfFiles.length} PDF file(s)`, 'success');
  }

  function displayFileList() {
      const fileList = document.getElementById('fileList');
      fileList.innerHTML = '';
      if (pdfFiles.length === 0) {
          fileList.innerHTML = '<div class="file-list-item" style="justify-content:center;color:#6b7280;">No files.</div>';
          return;
      }
      const header = document.createElement('div');
      header.className = 'file-list-header';
      header.innerHTML = `
          <div style="display:flex;align-items:center;gap:8px;">
              <input type="checkbox" id="selectAllFiles" class="form-check-input">
              <span>Select All (${pdfFiles.length})</span>
          </div>
          <span>Only checked documents will be processed.</span>
      `;
      fileList.appendChild(header);
      const selectAllCheckbox = header.querySelector('#selectAllFiles');
      selectAllCheckbox.checked = selectedPdfIndices.size === pdfFiles.length;
      selectAllCheckbox.addEventListener('change', function () {
          if (this.checked) selectedPdfIndices = new Set(pdfFiles.map((_,i)=>i));
          else selectedPdfIndices.clear();
          refreshFileCheckboxes();
      });

      pdfFiles.forEach((file,index) => {
          const item = document.createElement('div');
          item.className = 'file-list-item';
          const isProtected = protectedPdfFiles.includes(file);
          const protectedHtml = isProtected ? `<span class="protected-badge"><i class="bi bi-shield-lock"></i> Protected</span>` : '';
          const displayName = getFileActualName(file);
          item.innerHTML = `
              <input type="checkbox" class="form-check-input file-checkbox" data-index="${index}">
              <i class="bi bi-file-earmark-pdf" style="color:#ef4444;"></i>
              <div class="file-name-wrapper">
                  <span class="file-name-text" title="${displayName}">${displayName}</span>
                  ${protectedHtml}
              </div>
          `;
          fileList.appendChild(item);
      });

      refreshFileCheckboxes();
      fileList.addEventListener('change', function (e) {
          const cb = e.target.closest('.file-checkbox');
          if (!cb) return;
          const idx = parseInt(cb.getAttribute('data-index'));
          if (cb.checked) selectedPdfIndices.add(idx);
          else selectedPdfIndices.delete(idx);
          selectAllCheckbox.checked = selectedPdfIndices.size === pdfFiles.length;
      });
  }

  function refreshFileCheckboxes() {
      document.querySelectorAll('.file-checkbox').forEach(cb => {
          const idx = parseInt(cb.getAttribute('data-index'));
          cb.checked = selectedPdfIndices.has(idx);
      });
  }

  function changeFolder() {
      folderInput.value = '';
      pdfFiles = [];
      protectedPdfFiles = [];
      selectedPdfIndices.clear();
      folderUploadedMessage.classList.remove('show');
      dropZone.style.display = 'block';
      formChanged = false;
      selfValidationData = [];
  }

  function triggerFolderSelection() {
      document.getElementById('folderInput').click();
  }

  /* ===================== STEP 2: TEMPLATE DOWNLOAD ===================== */

  document.getElementById('downloadTemplateBtn').addEventListener('click', async function(){
      if (!pdfFiles || pdfFiles.length === 0) {
          showCustomAlert('No PDF files available. Please go back and select a folder.', 'error');
          return;
      }
      if (selectedPdfIndices.size === 0) {
          showCustomAlert('No documents selected. Please select at least one document in Step 1.', 'error');
          return;
      }
      isDownloadingTemplate = true;
      const formData = new FormData();
      Array.from(selectedPdfIndices).forEach(idx => formData.append('pdfFiles', pdfFiles[idx]));
      try{
          const loadingAlert = showCustomAlert('Downloading template...', 'info', false);
          const response = await fetch('/api/bulk-upload/generate-template',{method:'POST',body:formData});
          if (loadingAlert) loadingAlert.remove();
          if (!response.ok){
              if (response.status === 403){
                  showCustomAlert('Access Denied: Admin access required.', 'error');
                  isDownloadingTemplate = false; return;
              }
              throw new Error(`Download failed: ${response.status}`);
          }
          const blob = await response.blob();
          if (blob.size === 0) throw new Error('Received empty file');
          const cd = response.headers.get('Content-Disposition');
          let filename = 'bulk_upload_template.xlsx';
          if (cd){
              const m = cd.match(/filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/);
              if (m && m[1]) filename = m[1].replace(/['"]/g,'');
          }
          downloadBlob(blob, filename);
          showCustomAlert('Template downloaded successfully!', 'success');
      }catch(err){
          console.error('Template download error:', err);
          showCustomAlert(`Failed to download template: ${err.message}`, 'error');
      }finally{
          isDownloadingTemplate = false;
      }
  });

  function downloadBlob(blob, filename){
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = filename; a.style.display='none';
      document.body.appendChild(a); a.click();
      setTimeout(()=>{window.URL.revokeObjectURL(url);document.body.removeChild(a);},100);
  }

  /* ===================== STEP 3: EXCEL UPLOAD ===================== */

  const excelDropZone = document.getElementById('excelDropZone');
  const excelFileInput = document.getElementById('excelFileInput');
  const excelUploadedMessage = document.getElementById('excelUploadedMessage');

  ['dragenter','dragover','dragleave','drop'].forEach(ev=>{
      excelDropZone.addEventListener(ev,e=>{e.preventDefault();e.stopPropagation();});
  });
  ['dragenter','dragover'].forEach(ev=>{
      excelDropZone.addEventListener(ev,()=>excelDropZone.classList.add('dragover'));
  });
  ['dragleave','drop'].forEach(ev=>{
      excelDropZone.addEventListener(ev,()=>excelDropZone.classList.remove('dragover'));
  });
  excelDropZone.addEventListener('drop',e=>{
      const dt=e.dataTransfer; const files=dt.files;
      if (files.length>0) handleExcelFile(files[0]);
  });
  excelFileInput.addEventListener('change',e=>{
      if (e.target.files.length>0) handleExcelFile(e.target.files[0]);
  });

  function handleExcelFile(file){
      if (!file) return;
      const exts=['.xlsx','.xls'];
      const ext='.'+file.name.split('.').pop().toLowerCase();
      if (!exts.includes(ext)){
          showCustomAlert('Please upload a valid Excel file (.xlsx or .xls)');
          return;
      }
      excelFile=file;
      document.getElementById('uploadedExcelName').textContent=file.name;
      document.getElementById('uploadedExcelSize').textContent=formatFileSize(file.size);
      excelUploadedMessage.classList.add('show');
      excelDropZone.style.display='none';
      formChanged = true;
  }

  function changeExcelFile(){
      excelFileInput.value='';
      excelFile=null;
      excelUploadedMessage.classList.remove('show');
      excelDropZone.style.display='block';
      formChanged = true;
      selfValidationData = [];
  }

  /* ===================== STEP 5: VALIDATION - USES EDITED DATA ===================== */

  async function validateFiles(){
      if (selectedPdfIndices.size === 0){
          showCustomAlert('No documents selected. Please select at least one document in Step 1.', 'error');
          return;
      }

      updateWizardStep(5);
      document.getElementById('validationStatus').textContent='Validating...';
      document.getElementById('validationStatus').className='validation-status';
      document.getElementById('validationErrorActions').classList.remove('show');

      const formData = new FormData();
      Array.from(selectedPdfIndices).forEach(idx=>formData.append('pdfFiles', pdfFiles[idx]));
      formData.append('excelFile', excelFile);

      if (selfValidationData && selfValidationData.length > 0) {
          const jsonString = JSON.stringify(selfValidationData);
          formData.append('selfValidationJson', jsonString);
          console.log('=== SENDING TO VALIDATION API ===');
          console.log('selfValidationJson:', jsonString);
      } else {
          console.warn('WARNING: selfValidationData is empty!');
      }

      try{
          const response = await fetch('/api/bulk-upload/validate',{method:'POST',body:formData});
          if (!response.ok){
              if (response.status===403){
                  showCustomAlert('Access Denied: Admin access required.', 'error');
                  return;
              }
              throw new Error('Validation failed');
          }
          validationResult = await response.json();
          console.log('=== VALIDATION RESULT ===');
          console.log(validationResult);
          displayValidationResults(validationResult);
      }catch(err){
          console.error('Validation error:', err);
          showCustomAlert('Validation failed. Please check your files and try again.', 'error');
      }
  }

  function displayValidationResults(result){
      document.getElementById('totalDocuments').textContent = result.totalDocuments || 0;
      document.getElementById('validDocuments').textContent = result.validDocuments || 0;
      document.getElementById('warningCount').textContent = result.warnings?.length || 0;
      document.getElementById('errorCount').textContent = result.errors?.length || 0;

      const issues = document.getElementById('validationIssues');
      issues.innerHTML='';
      const hasErrors = result.errors && result.errors.length>0;
      if (hasErrors){
          result.errors.forEach(e=>{
              const o = typeof e === 'string' ? JSON.parse(e) : e;
              issues.appendChild(createIssueItem(o,'error'));
          });
      }
      if (result.warnings && result.warnings.length>0){
          result.warnings.forEach(w=>{
              const o = typeof w === 'string' ? JSON.parse(w) : w;
              issues.appendChild(createIssueItem(o,'warning'));
          });
      }
      if (issues.innerHTML===''){
          issues.innerHTML='<div style="padding:20px;text-align:center;color:#10b981;"><i class="bi bi-check-circle" style="font-size:24px;"></i><br><br>No issues found! All documents are ready to upload.</div>';
      }
      if (hasErrors){
          document.getElementById('validationStatus').textContent='Has Errors';
          document.getElementById('validationStatus').classList.add('error');
          document.getElementById('validationErrorActions').classList.add('show');
      }else if (result.warnings && result.warnings.length>0){
          document.getElementById('validationStatus').textContent='Ready with Warnings';
          document.getElementById('validationStatus').classList.add('warning');
      }else{
          document.getElementById('validationStatus').textContent='All Valid';
          document.getElementById('validationStatus').classList.add('success');
      }
      updateStep5Navigation(hasErrors);
      if (hasErrors){
          showCustomAlert(`Validation complete. ${result.validDocuments} documents are ready to upload.`, 'warning');
      }else{
          showCustomAlert('Validation successful! Click "Upload" to proceed.', 'success');
      }
  }

  function createIssueItem(issue,type){
      const item=document.createElement('div');
      item.className='issue-item';
      item.innerHTML=`
          <div class="issue-icon ${type}">
              <i class="bi bi-${type==='error'?'x-circle':'exclamation-triangle'}"></i>
          </div>
          <div class="issue-content">
              <div class="issue-title">${issue.title || issue.message}</div>
              <div class="issue-desc">${issue.description || issue.details || ''}</div>
          </div>
      `;
      return item;
  }

  /* ===================== STEP 6: UPLOAD - USES EDITED DATA ===================== */

  async function startUpload(onlyValid=false){
      if (selectedPdfIndices.size === 0){
          showCustomAlert('No documents selected. Please select at least one document in Step 1.', 'error');
          return;
      }

      updateWizardStep(6);
      isSubmitting = true;
      uploadStartTime = Date.now();

      const formData = new FormData();
      Array.from(selectedPdfIndices).forEach(idx=>formData.append('pdfFiles', pdfFiles[idx]));
      formData.append('excelFile', excelFile);
      if (onlyValid) formData.append('uploadOnlyValid','true');

      if (selfValidationData && selfValidationData.length > 0) {
          const jsonString = JSON.stringify(selfValidationData);
          formData.append('selfValidationJson', jsonString);
          console.log('=== SENDING TO UPLOAD API ===');
          console.log('selfValidationJson:', jsonString);
      } else {
          console.warn('WARNING: selfValidationData is empty for upload!');
      }

      try{
          const response = await fetch('/api/bulk-upload/process',{method:'POST',body:formData});
          if (!response.ok){
              if (response.status===403){
                  showCustomAlert('Access Denied: Admin access required.', 'error');
                  isSubmitting=false;
                  return;
              }
              throw new Error('Upload failed');
          }
          const docsToUpload = onlyValid
              ? (validationResult?.validDocuments || 0)
              : (validationResult?.totalDocuments || selectedPdfIndices.size);
          await simulateProgress(docsToUpload);
          const result = await response.json();
          showCompletion(result);
      }catch(err){
          console.error('Upload error:', err);
          showCustomAlert('Upload failed. Please try again.', 'error');
          isSubmitting=false;
      }
  }

  async function simulateProgress(totalDocs){
      const bar=document.getElementById('progressBar');
      const text=document.getElementById('progressText');
      const log=document.getElementById('uploadLog');
      log.innerHTML='';
      const selectedFilesArray = Array.from(selectedPdfIndices).map(idx=>pdfFiles[idx]);
      for(let i=1;i<=totalDocs;i++){
          const pct=Math.round((i/totalDocs)*100);
          bar.style.width=pct+'%';
          bar.textContent=pct+'%';
          text.textContent=`Processing ${i} of ${totalDocs} documents...`;
          const file = selectedFilesArray[i-1];
          const displayName = getFileActualName(file);
          const li=document.createElement('div');
          li.className='log-item';
          li.innerHTML=`
              <div class="log-icon processing"><i class="bi bi-arrow-repeat"></i></div>
              <div class="log-text">Uploading ${displayName}...</div>
          `;
          log.appendChild(li);
          log.scrollTop=log.scrollHeight;
          await new Promise(r=>setTimeout(r,300));
          li.innerHTML=`
              <div class="log-icon success"><i class="bi bi-check"></i></div>
              <div class="log-text">${displayName} uploaded successfully</div>
          `;
      }
  }

  function showCompletion(result){
      const endTime=Date.now();
      const totalTime=Math.round((endTime-uploadStartTime)/1000);
      const successCount=result.successCount || 0;
      const failedCount=result.failedCount || 0;
      let msg=`Bulk upload complete! ${successCount} documents uploaded successfully.`;
      if (failedCount>0) msg += ` ${failedCount} documents were skipped due to errors.`;
      msg += ` Time taken: ${totalTime}s.`;
      showCustomAlert(msg,'success');
      setTimeout(()=>{window.location.href='/documents';},2000);
  }

  /* ===================== VALIDATION ERROR ACTIONS ===================== */

  // FEATURE 1: Enhanced upload valid confirmation with document list
  document.getElementById('uploadValidBtn').addEventListener('click', showUploadValidConfirmation);
  function showUploadValidConfirmation() {
      if (!validationResult) return;

      const totalDocs = validationResult.totalDocuments || 0;
      const validDocs = validationResult.validDocuments || 0;
      const errorDocs = totalDocs - validDocs;

      document.getElementById('validDocsCount').textContent = validDocs;
      document.getElementById('errorDocsCount').textContent = errorDocs;

      // FEATURE 1: Build skipped documents list
      const skippedList = document.getElementById('skippedDocumentsList');
      if (skippedList) {
          skippedList.innerHTML = '';

          if (validationResult.errors && validationResult.errors.length > 0) {
              const skippedFilenames = new Set();

              validationResult.errors.forEach(errorObj => {
                  const errorStr = typeof errorObj === 'string' ? errorObj : JSON.stringify(errorObj);

                  // Try to parse error to get filename
                  try {
                      const parsed = typeof errorObj === 'string' ? JSON.parse(errorObj) : errorObj;
                      const desc = parsed.description || parsed.details || parsed.message || '';

                      // Extract filename from error message
                      const match = desc.match(/Document '([^']+)'/);
                      if (match && match[1]) {
                          skippedFilenames.add(match[1]);
                      }
                  } catch (e) {
                      // If parsing fails, try regex on string
                      const match = errorStr.match(/Document '([^']+)'/);
                      if (match && match[1]) {
                          skippedFilenames.add(match[1]);
                      }
                  }
              });

              if (skippedFilenames.size > 0) {
                  Array.from(skippedFilenames).forEach(filename => {
                      const item = document.createElement('div');
                      item.className = 'skipped-doc-item';
                      item.innerHTML = `
                          <i class="bi bi-file-earmark-pdf-fill" style="color:#ef4444;"></i>
                          <span>${filename}</span>
                      `;
                      skippedList.appendChild(item);
                  });
              } else {
                  skippedList.innerHTML = '<div style="color:#6b7280;font-size:13px;">Unable to determine specific documents with errors.</div>';
              }
          }
      }

      document.getElementById('uploadValidConfirmModal').classList.add('show');
  }

  function closeUploadValidConfirmModal() {
      document.getElementById('uploadValidConfirmModal').classList.remove('show');
  }
  document.getElementById('confirmUploadValidBtn').addEventListener('click', async function () {
      closeUploadValidConfirmModal();
      const o = formChanged; formChanged = false;
      await startUpload(true);
      formChanged = o;
  });

  document.getElementById('reuploadFolderBtn').addEventListener('click',function(){
      changeFolder();
      changeExcelFile();
      const o=formChanged; formChanged=false;
      updateWizardStep(1);
      formChanged=o;
      showCustomAlert('Please select a new folder with PDF files.', 'info');
  });
  document.getElementById('reuploadExcelBtn').addEventListener('click',function(){
      changeExcelFile();
      const o=formChanged; formChanged=false;
      updateWizardStep(3);
      formChanged=o;
      showCustomAlert('Please upload the corrected metadata Excel file.', 'info');
  });

  /* ===================== CANCEL / NAVIGATION GUARD ===================== */

  document.getElementById('cancelBtn').addEventListener('click', function(){
      if (formChanged && !isSubmitting){
          document.getElementById('confirmationModal').classList.add('show');
      } else {
          navigateAway();
      }
  });

  function closeConfirmationModal(){
      document.getElementById('confirmationModal').classList.remove('show');
  }

  document.getElementById('confirmCancelBtn').addEventListener('click',function(){
      closeConfirmationModal();
      navigateAway();
  });

  function navigateAway(){
      formChanged=false;
      isSubmitting=true;
      if (lastVisitedUrl && lastVisitedUrl !== window.location.href){
          window.location.href = lastVisitedUrl;
      } else {
          window.location.href = '/documents';
      }
  }

  window.history.pushState(null,'',window.location.href);
  window.addEventListener('popstate',function(e){
      if (formChanged && !isSubmitting && !navigationConfirmed){
          window.history.pushState(null,'',window.location.href);
          showNavigationConfirmation('back');
      }
  });
  window.addEventListener('beforeunload',function(e){
      if (formChanged && !isSubmitting){
          e.preventDefault();
          e.returnValue='';
          return '';
      }
  });

  document.addEventListener('click',function(e){
      const link = e.target.closest('a');
      const button = e.target.closest('button');
      if (isDownloadingTemplate) return;
      if (button){
          const wizardBtns=['nextBtn','prevBtn','cancelBtn','downloadTemplateBtn','reuploadFolderBtn','reuploadExcelBtn','uploadValidBtn','confirmUploadValidBtn','editMetadataBtn','doneMetadataBtn'];
          if (wizardBtns.includes(button.id)) return;
      }
      if (link && link.href && !link.hasAttribute('data-bs-toggle')){
          const isWizardButton = link.closest('.wizard-navigation') ||
                                 link.closest('.wizard-content') ||
                                 link.id==='confirmCancelBtn' ||
                                 link.classList.contains('modal-btn') ||
                                 link.classList.contains('change-file-btn') ||
                                 link.classList.contains('download-template-btn');
          const isNavLink = link.closest('.navbar') ||
                            link.closest('.sidebar') ||
                            link.closest('nav') ||
                            link.hasAttribute('href');
          if (isNavLink && !isWizardButton && formChanged && !isSubmitting && !navigationConfirmed){
              e.preventDefault(); e.stopPropagation(); e.stopImmediatePropagation();
              const targetUrl = link.href;
              showNavigationConfirmation(targetUrl);
              return false;
          }
      }
  },true);

  function showNavigationConfirmation(targetUrl){
      pendingNavigationUrl = targetUrl;
      const modal = document.getElementById('confirmationModal');
      modal.classList.add('show');
      const confirmBtn = document.getElementById('confirmCancelBtn');
      const newConfirmBtn = confirmBtn.cloneNode(true);
      confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
      newConfirmBtn.onclick = function(){
          navigationConfirmed = true;
          formChanged = false;
          isSubmitting = true;
          closeConfirmationModal();
          if (pendingNavigationUrl === 'back'){
              if (lastVisitedUrl && lastVisitedUrl !== window.location.href){
                  window.location.href = lastVisitedUrl;
              } else {
                  window.location.href = '/documents';
              }
          } else {
              window.location.href = pendingNavigationUrl;
          }
      };
  }

  document.addEventListener('submit',function(e){
      if (formChanged && !isSubmitting && !navigationConfirmed){
          e.preventDefault();
          showNavigationConfirmation(e.target.action);
      }
  },true);

  /* ===================== UTILITIES ===================== */

  function formatFileSize(bytes){
      if (bytes===0) return '0 Bytes';
      const k=1024; const sizes=['Bytes','KB','MB','GB'];
      const i=Math.floor(Math.log(bytes)/Math.log(k));
      return Math.round(bytes/Math.pow(k,i)*100)/100+' '+sizes[i];
  }

  function showCustomAlert(message,type='error',autoClose=true){
      const alertDiv=document.createElement('div');
      const bgColor=type==='error'?'#ef4444':type==='success'?'#10b981':'#3b82f6';
      alertDiv.style.cssText=`
          position:fixed;top:20px;right:20px;background:${bgColor};color:#fff;
          padding:16px 24px;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,0.3);
          z-index:10000;animation:slideInRight .3s ease;max-width:400px;display:flex;align-items:center;gap:10px;
      `;
      alertDiv.innerHTML=`
          <i class="bi bi-${type==='error'?'exclamation-circle-fill':type==='success'?'check-circle-fill':'info-circle-fill'}" style="font-size:20px;"></i>
          <span>${message}</span>
      `;
      document.body.appendChild(alertDiv);
      if (autoClose){
          setTimeout(()=>{
              alertDiv.style.animation='slideOutRight .3s ease';
              setTimeout(()=>alertDiv.remove(),300);
          },3000);
      }
      return alertDiv;
  }

  function goBack(){
      if (formChanged && !isSubmitting){
          document.getElementById('confirmationModal').classList.add('show');
          const confirmBtn = document.getElementById('confirmCancelBtn');
          confirmBtn.onclick=function(){
              navigationConfirmed=true;
              formChanged=false;
              isSubmitting=true;
              closeConfirmationModal();
              if (lastVisitedUrl && lastVisitedUrl !== window.location.href){
                  window.location.href = lastVisitedUrl;
              } else {
                  window.location.href = '/documents';
              }
          };
      } else if (lastVisitedUrl && lastVisitedUrl !== window.location.href){
          window.location.href = lastVisitedUrl;
      } else {
          window.location.href = '/documents';
      }
  }

  updateWizardStep(1);
  window.addEventListener('load',function(){
      setTimeout(()=>{
          const alerts=document.querySelectorAll('.alert');
          alerts.forEach(a=>{
              const bsAlert=bootstrap.Alert.getOrCreateInstance(a);
              if (bsAlert) bsAlert.close();
          });
      },5000);
  });
</script>


</body>
</html>