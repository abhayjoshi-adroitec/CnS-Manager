<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bulk Upload Documents - Codes & Standards</title>
    <link rel="stylesheet" href="/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

    <!-- Include Sidebar Styles -->
    <th:block th:replace="~{common/sidebar :: sidebar-styles}"></th:block>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background-color: #f4f6f9;
            padding-top: 70px;
        }

        .bulk-upload-container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .bulk-header {
            background: linear-gradient(135deg, #1e3a5f 0%, #2d5a8f 100%);
            padding: 30px 40px;
            color: white;
        }

        .bulk-header h2 {
            margin: 0;
            font-size: 26px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .bulk-header p {
            margin: 8px 0 0;
            opacity: 0.9;
            font-size: 14px;
        }

        .bulk-content {
            padding: 40px;
        }

        .step-indicator {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 40px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .step-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 20px;
            background: white;
            border-radius: 8px;
            font-weight: 500;
            color: #6b7280;
            border: 2px solid #e5e7eb;
        }

        .step-item.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .step-item.completed {
            background: #10b981;
            color: white;
            border-color: #10b981;
        }

        .upload-section {
            display: grid;
            grid-template-columns: 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .upload-card {
            background: #f9fafb;
            border: 2px dashed #d1d5db;
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            transition: all 0.3s;
            cursor: pointer;
        }

        .upload-card:hover {
            border-color: #667eea;
            background: #f0f4ff;
            transform: translateY(-2px);
        }

        .upload-card.has-file {
            border-style: solid;
            border-color: #10b981;
            background: #ecfdf5;
        }

        .upload-icon {
            width: 80px;
            height: 80px;
            margin: 0 auto 20px;
            color: #667eea;
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
            border-radius: 50%;
        }

        .upload-card.has-file .upload-icon {
            color: #10b981;
        }

        .upload-title {
            font-size: 18px;
            font-weight: 600;
            color: #1a2332;
            margin-bottom: 10px;
        }

        .upload-desc {
            font-size: 14px;
            color: #6b7280;
            margin-bottom: 20px;
        }

        .upload-btn {
            background: #667eea;
            color: white;
            padding: 12px 28px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .upload-btn:hover {
            background: #5568d3;
            transform: translateY(-2px);
        }

        .file-info {
            display: none;
            margin-top: 20px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            text-align: left;
        }

        .file-info.show {
            display: block;
        }

        .file-info-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #e5e7eb;
        }

        .file-info-item:last-child {
            border-bottom: none;
        }

        .file-info-label {
            font-weight: 600;
            color: #374151;
            font-size: 14px;
        }

        .file-info-value {
            color: #6b7280;
            font-size: 14px;
        }

        .change-file-link {
            color: #667eea;
            cursor: pointer;
            font-size: 13px;
            text-decoration: underline;
        }

        .change-file-link:hover {
            color: #5568d3;
        }

        .info-box {
            background: #eff6ff;
            border-left: 4px solid #3b82f6;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
        }

        .info-box-title {
            font-weight: 600;
            color: #1e40af;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .info-box-content {
            color: #1e40af;
            font-size: 14px;
            line-height: 1.6;
        }

        .info-box ul {
            margin: 10px 0 0 0;
            padding-left: 20px;
        }

        .info-box li {
            margin-bottom: 5px;
        }

        .download-template-btn {
            background: #10b981;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
        }

        .download-template-btn:hover {
            background: #059669;
            transform: translateY(-2px);
            color: white;
        }

        .file-list {
            max-height: 300px;
            overflow-y: auto;
            margin-top: 15px;
            background: white;
            border-radius: 8px;
            padding: 10px;
        }

        .file-list-item {
            padding: 8px 12px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 13px;
            color: #374151;
        }

        .file-list-item:last-child {
            border-bottom: none;
        }

        .file-list-item i {
            color: #ef4444;
        }

        .validation-section {
            display: none;
            margin-top: 30px;
        }

        .validation-section.show {
            display: block;
        }

        .validation-results {
            background: #f9fafb;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
        }

        .validation-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .validation-title {
            font-size: 18px;
            font-weight: 600;
            color: #1a2332;
        }

        .validation-status {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
        }

        .validation-status.success {
            background: #d1fae5;
            color: #065f46;
        }

        .validation-status.warning {
            background: #fef3c7;
            color: #92400e;
        }

        .validation-status.error {
            background: #fee2e2;
            color: #991b1b;
        }

        .validation-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            border: 2px solid #e5e7eb;
        }

        .stat-number {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 13px;
            color: #6b7280;
            font-weight: 500;
        }

        .stat-card.total .stat-number { color: #3b82f6; }
        .stat-card.valid .stat-number { color: #10b981; }
        .stat-card.warnings .stat-number { color: #f59e0b; }
        .stat-card.errors .stat-number { color: #ef4444; }

        .validation-issues {
            background: white;
            border-radius: 8px;
            overflow: hidden;
        }

        .issue-item {
            padding: 15px 20px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            align-items: start;
            gap: 12px;
        }

        .issue-item:last-child {
            border-bottom: none;
        }

        .issue-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .issue-icon.warning {
            background: #fef3c7;
            color: #f59e0b;
        }

        .issue-icon.error {
            background: #fee2e2;
            color: #ef4444;
        }

        .issue-content {
            flex: 1;
        }

        .issue-title {
            font-weight: 600;
            color: #1a2332;
            margin-bottom: 4px;
        }

        .issue-desc {
            font-size: 14px;
            color: #6b7280;
        }

        .action-buttons {
            display: flex;
            justify-content: space-between;
            padding-top: 30px;
            border-top: 2px solid #e5e7eb;
        }

        .btn-secondary {
            background: #f3f4f6;
            color: #374151;
            padding: 12px 28px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-secondary:hover {
            background: #e5e7eb;
        }

        .btn-primary {
            background: #667eea;
            color: white;
            padding: 12px 28px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary:hover {
            background: #5568d3;
        }

        .btn-primary:disabled {
            background: #d1d5db;
            cursor: not-allowed;
        }

        .progress-section {
            display: none;
            margin-top: 30px;
        }

        .progress-section.show {
            display: block;
        }

        .progress-container {
            background: #f9fafb;
            border-radius: 12px;
            padding: 30px;
        }

        .progress-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .progress-title {
            font-size: 20px;
            font-weight: 600;
            color: #1a2332;
            margin-bottom: 10px;
        }

        .progress-subtitle {
            color: #6b7280;
            font-size: 14px;
        }

        .progress-bar-container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .progress-bar-wrapper {
            background: #e5e7eb;
            height: 30px;
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            border-radius: 15px;
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 14px;
        }

        .progress-text {
            text-align: center;
            color: #6b7280;
            font-size: 14px;
        }

        .upload-log {
            background: white;
            border-radius: 8px;
            max-height: 300px;
            overflow-y: auto;
        }

        .log-item {
            padding: 12px 20px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 14px;
        }

        .log-item:last-child {
            border-bottom: none;
        }

        .log-icon {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .log-icon.success {
            background: #d1fae5;
            color: #10b981;
        }

        .log-icon.error {
            background: #fee2e2;
            color: #ef4444;
        }

        .log-icon.processing {
            background: #dbeafe;
            color: #3b82f6;
        }

        .log-text {
            flex: 1;
            color: #374151;
        }

        .completion-section {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .completion-section.show {
            display: block;
        }

        .completion-icon {
            width: 100px;
            height: 100px;
            background: #d1fae5;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            color: #10b981;
            font-size: 50px;
        }

        .completion-title {
            font-size: 24px;
            font-weight: 600;
            color: #1a2332;
            margin-bottom: 10px;
        }

        .completion-subtitle {
            color: #6b7280;
            font-size: 16px;
            margin-bottom: 30px;
        }

        .completion-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            max-width: 600px;
            margin: 0 auto 30px;
        }

        @media (max-width: 992px) {
            .validation-stats {
                grid-template-columns: repeat(2, 1fr);
            }

            .completion-stats {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .bulk-content {
                padding: 20px;
            }

            .step-indicator {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
<!-- Include Top Navbar -->
<div th:replace="~{common/navbar :: navbar}"></div>

<!-- Sidebar + Content -->
<div class="d-flex">
    <!-- Include Sidebar -->
    <div th:replace="~{common/sidebar :: sidebar}"></div>

    <!-- Main Content -->
    <div class="main-content flex-grow-1 p-4">
        <!-- Bulk Upload Container -->
        <div class="bulk-upload-container">
            <!-- Header -->
            <div class="bulk-header">
                <h2>
                    <i class="bi bi-cloud-upload-fill"></i>
                    Bulk Upload Documents
                </h2>
                <p>Upload multiple documents at once using folder selection and Excel metadata</p>
            </div>

            <!-- Content -->
            <div class="bulk-content">
                <!-- Step Indicator -->
                <div class="step-indicator">
                    <div class="step-item active" id="step1Indicator">
                        <i class="bi bi-folder2"></i>
                        <span>Select Folder</span>
                    </div>
                    <div class="step-item" id="step2Indicator">
                        <i class="bi bi-file-earmark-excel"></i>
                        <span>Generate Template</span>
                    </div>
                    <div class="step-item" id="step3Indicator">
                        <i class="bi bi-check-square"></i>
                        <span>Validate</span>
                    </div>
                    <div class="step-item" id="step4Indicator">
                        <i class="bi bi-cloud-upload"></i>
                        <span>Upload</span>
                    </div>
                </div>

                <!-- Info Box -->
                <div class="info-box">
                    <div class="info-box-title">
                        <i class="bi bi-info-circle-fill"></i>
                        How Bulk Upload Works
                    </div>
                    <div class="info-box-content">
                        <ul>
                            <li><strong>Select Folder:</strong> Choose a folder containing PDF files</li>
                            <li><strong>Generate Template:</strong> System will create Excel template with all PDF filenames</li>
                            <li><strong>Fill Metadata:</strong> Download, fill metadata in Excel and re-upload</li>
                            <li><strong>Validation & Upload:</strong> System validates and uploads all documents</li>
                        </ul>
                    </div>
                </div>

                <!-- Upload Section - Folder Selection -->
                <div class="upload-section" id="folderSection">
                    <div class="upload-card" id="folderUploadCard" onclick="document.getElementById('folderInput').click()">
                        <div class="upload-icon">
                            <i class="bi bi-folder2-open" style="font-size: 40px;"></i>
                        </div>
                        <div class="upload-title">Select Folder with PDF Files</div>
                        <div class="upload-desc">Choose a folder containing all your PDF documents</div>
                        <button type="button" class="upload-btn">
                            <i class="bi bi-folder2-open"></i>
                            Browse Folder
                        </button>
                        <input type="file" id="folderInput" webkitdirectory directory multiple style="display: none;">

                        <div class="file-info" id="folderFileInfo">
                            <div class="file-info-item">
                                <span class="file-info-label">PDF Files Found:</span>
                                <span class="file-info-value" id="folderFileCount">0</span>
                            </div>
                            <div class="file-info-item">
                                <span class="file-info-label">Total Size:</span>
                                <span class="file-info-value" id="folderFileSize">0 MB</span>
                            </div>
                            <div class="file-info-item">
                                <span class="file-info-label"></span>
                                <span class="change-file-link" onclick="changeFolder(event)">Change Folder</span>
                            </div>
                            <div class="file-list" id="fileList">
                                <!-- PDF file list will appear here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Excel Upload Section (Step 2) -->
                <div class="upload-section" id="excelSection" style="display: none;">
                    <div class="upload-card" id="excelUploadCard" onclick="document.getElementById('excelFileInput').click()">
                        <div class="upload-icon">
                            <i class="bi bi-file-earmark-excel" style="font-size: 40px;"></i>
                        </div>
                        <div class="upload-title">Upload Filled Metadata Excel</div>
                        <div class="upload-desc">Upload the Excel file after filling all metadata</div>
                        <button type="button" class="upload-btn">
                            <i class="bi bi-folder2-open"></i>
                            Browse File
                        </button>
                        <input type="file" id="excelFileInput" accept=".xlsx,.xls" style="display: none;">

                        <div class="file-info" id="excelFileInfo">
                            <div class="file-info-item">
                                <span class="file-info-label">File Name:</span>
                                <span class="file-info-value" id="excelFileName">-</span>
                            </div>
                            <div class="file-info-item">
                                <span class="file-info-label">Size:</span>
                                <span class="file-info-value" id="excelFileSize">0 KB</span>
                            </div>
                            <div class="file-info-item">
                                <span class="file-info-label"></span>
                                <span class="change-file-link" onclick="changeExcelFile(event)">Change File</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Validation Section -->
                <div class="validation-section" id="validationSection">
                    <div class="validation-results">
                        <div class="validation-header">
                            <div class="validation-title">Validation Results</div>
                            <div class="validation-status" id="validationStatus">Validating...</div>
                        </div>

                        <div class="validation-stats">
                            <div class="stat-card total">
                                <div class="stat-number" id="totalDocuments">0</div>
                                <div class="stat-label">Total Documents</div>
                            </div>
                            <div class="stat-card valid">
                                <div class="stat-number" id="validDocuments">0</div>
                                <div class="stat-label">Valid</div>
                            </div>
                            <div class="stat-card warnings">
                                <div class="stat-number" id="warningCount">0</div>
                                <div class="stat-label">Warnings</div>
                            </div>
                            <div class="stat-card errors">
                                <div class="stat-number" id="errorCount">0</div>
                                <div class="stat-label">Errors</div>
                            </div>
                        </div>

                        <div class="validation-issues" id="validationIssues">
                            <!-- Issues will be populated here -->
                        </div>
                    </div>
                </div>

                <!-- Progress Section -->
                <div class="progress-section" id="progressSection">
                    <div class="progress-container">
                        <div class="progress-header">
                            <div class="progress-title">Uploading Documents...</div>
                            <div class="progress-subtitle">Please wait while we process your documents</div>
                        </div>

                        <div class="progress-bar-container">
                            <div class="progress-bar-wrapper">
                                <div class="progress-bar-fill" id="progressBar" style="width: 0%">0%</div>
                            </div>
                            <div class="progress-text" id="progressText">Processing 0 of 0 documents...</div>
                        </div>

                        <div class="upload-log" id="uploadLog">
                            <!-- Log items will be populated here -->
                        </div>
                    </div>
                </div>

                <!-- Completion Section -->
                <div class="completion-section" id="completionSection">
                    <div class="completion-icon">
                        <i class="bi bi-check-circle-fill"></i>
                    </div>
                    <div class="completion-title">Bulk Upload Complete!</div>
                    <div class="completion-subtitle">All documents have been processed successfully</div>

                    <div class="completion-stats">
                        <div class="stat-card">
                            <div class="stat-number" style="color: #10b981;" id="successCount">0</div>
                            <div class="stat-label">Uploaded Successfully</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" style="color: #ef4444;" id="failedCount">0</div>
                            <div class="stat-label">Failed</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" style="color: #3b82f6;" id="totalTime">0s</div>
                            <div class="stat-label">Total Time</div>
                        </div>
                    </div>

                    <div style="display: flex; gap: 15px; justify-content: center;">
                        <a href="/documents" class="btn-primary">
                            <i class="bi bi-list-ul"></i>
                            View All Documents
                        </a>
                        <button type="button" class="btn-secondary" onclick="resetUpload()">
                            <i class="bi bi-arrow-repeat"></i>
                            Upload More
                        </button>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="action-buttons" id="actionButtons">
                    <div>
                        <button type="button" class="btn-secondary" onclick="goBack()">
                            <i class="bi bi-arrow-left"></i>
                            Back
                        </button>
                    </div>
                    <div style="display: flex; gap: 12px;">
                        <button type="button" class="btn-secondary" id="resetBtn" style="display: none;" onclick="resetUpload()">
                            <i class="bi bi-arrow-repeat"></i>
                            Reset
                        </button>
                        <button type="button" class="btn-primary" id="generateTemplateBtn" disabled>
                            <i class="bi bi-file-earmark-excel"></i>
                            Generate Template
                        </button>
                        <button type="button" class="btn-primary" id="validateBtn" style="display: none;" disabled>
                            <i class="bi bi-check-square"></i>
                            Validate
                        </button>
                        <button type="button" class="btn-primary" id="uploadBtn" style="display: none;" disabled>
                            <i class="bi bi-cloud-upload"></i>
                            Start Upload
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="/js/bootstrap.bundle.min.js"></script>
<div th:replace="~{common/navbar :: navbar-js}"></div>

<script>
    let pdfFiles = [];
    let excelFile = null;
    let validationResult = null;
    let uploadStartTime = null;

    // Folder Selection
    document.getElementById('folderInput').addEventListener('change', function(e) {
        handleFolderSelection(e.target.files);
    });

    function handleFolderSelection(files) {
        // Filter only PDF files
        pdfFiles = Array.from(files).filter(file =>
            file.name.toLowerCase().endsWith('.pdf')
        );

        if (pdfFiles.length === 0) {
            showAlert('No PDF files found in the selected folder', 'error');
            return;
        }

        let totalSize = 0;
        pdfFiles.forEach(file => {
            totalSize += file.size;
        });

        document.getElementById('folderFileCount').textContent = pdfFiles.length;
        document.getElementById('folderFileSize').textContent = formatFileSize(totalSize);
        document.getElementById('folderFileInfo').classList.add('show');
        document.getElementById('folderUploadCard').classList.add('has-file');

        // Display file list
        displayFileList();

        // Enable generate template button
        document.getElementById('generateTemplateBtn').disabled = false;
    }

    function displayFileList() {
        const fileList = document.getElementById('fileList');
        fileList.innerHTML = '';

        pdfFiles.forEach((file, index) => {
            const item = document.createElement('div');
            item.className = 'file-list-item';
            item.innerHTML = `
                <i class="bi bi-file-earmark-pdf"></i>
                <span>${file.name}</span>
            `;
            fileList.appendChild(item);
        });
    }

    function changeFolder(event) {
        event.stopPropagation();
        document.getElementById('folderInput').value = '';
        document.getElementById('folderInput').click();
    }

    // Generate Template Button
    document.getElementById('generateTemplateBtn').addEventListener('click', async function() {
        await generateTemplate();
    });

    async function generateTemplate() {
        updateStepIndicator(2);

        const formData = new FormData();
        pdfFiles.forEach(file => {
            formData.append('pdfFiles', file);
        });

        try {
            const response = await fetch('/api/bulk-upload/generate-template', {
                method: 'POST',
                body: formData
            });

            if (!response.ok) {
                throw new Error('Template generation failed');
            }

            // Download the generated template
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'bulk_upload_template.xlsx';
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);

            showAlert('Template generated successfully! Please fill it and upload.', 'success');

            // Show excel upload section
            document.getElementById('folderSection').style.display = 'none';
            document.getElementById('excelSection').style.display = 'grid';
            document.getElementById('generateTemplateBtn').style.display = 'none';
            document.getElementById('resetBtn').style.display = 'inline-flex';

        } catch (error) {
            console.error('Template generation error:', error);
            showAlert('Failed to generate template. Please try again.', 'error');
        }
    }

    // Excel File Upload
    document.getElementById('excelFileInput').addEventListener('change', function(e) {
        handleExcelFile(e.target.files[0]);
    });

    function handleExcelFile(file) {
        if (!file) return;

        excelFile = file;

        document.getElementById('excelFileName').textContent = file.name;
        document.getElementById('excelFileSize').textContent = formatFileSize(file.size);
        document.getElementById('excelFileInfo').classList.add('show');
        document.getElementById('excelUploadCard').classList.add('has-file');

        document.getElementById('validateBtn').style.display = 'inline-flex';
        document.getElementById('validateBtn').disabled = false;
    }

    function changeExcelFile(event) {
        event.stopPropagation();
        document.getElementById('excelFileInput').value = '';
        document.getElementById('excelFileInput').click();
    }

    // Validate Button Click
    document.getElementById('validateBtn').addEventListener('click', async function() {
        await validateFiles();
    });

    // Validate Files
    async function validateFiles() {
        updateStepIndicator(3);
        document.getElementById('validationSection').classList.add('show');
        document.getElementById('validationStatus').textContent = 'Validating...';
        document.getElementById('validationStatus').className = 'validation-status';

        const formData = new FormData();
        pdfFiles.forEach(file => {
            formData.append('pdfFiles', file);
        });
        formData.append('excelFile', excelFile);

        try {
            const response = await fetch('/api/bulk-upload/validate', {
                method: 'POST',
                body: formData
            });

            if (!response.ok) {
                throw new Error('Validation failed');
            }

            validationResult = await response.json();
            displayValidationResults(validationResult);

        } catch (error) {
            console.error('Validation error:', error);
            showAlert('Validation failed. Please check your files and try again.', 'error');
        }
    }

    // Display Validation Results
    function displayValidationResults(result) {
        document.getElementById('totalDocuments').textContent = result.totalDocuments || 0;
        document.getElementById('validDocuments').textContent = result.validDocuments || 0;
        document.getElementById('warningCount').textContent = result.warnings?.length || 0;
        document.getElementById('errorCount').textContent = result.errors?.length || 0;

        const issuesContainer = document.getElementById('validationIssues');
        issuesContainer.innerHTML = '';

        // Show errors
        if (result.errors && result.errors.length > 0) {
            result.errors.forEach(error => {
                const issueItem = createIssueItem(error, 'error');
                issuesContainer.appendChild(issueItem);
            });
        }

        // Show warnings
        if (result.warnings && result.warnings.length > 0) {
            result.warnings.forEach(warning => {
                const issueItem = createIssueItem(warning, 'warning');
                issuesContainer.appendChild(issueItem);
            });
        }

        // Update status
        if (result.errors && result.errors.length > 0) {
            document.getElementById('validationStatus').textContent = 'Has Errors';
            document.getElementById('validationStatus').classList.add('error');
            document.getElementById('uploadBtn').disabled = true;
        } else if (result.warnings && result.warnings.length > 0) {
            document.getElementById('validationStatus').textContent = 'Ready with Warnings';
            document.getElementById('validationStatus').classList.add('warning');
            document.getElementById('uploadBtn').disabled = false;
        } else {
            document.getElementById('validationStatus').textContent = 'All Valid';
            document.getElementById('validationStatus').classList.add('success');
            document.getElementById('uploadBtn').disabled = false;
        }

        if (issuesContainer.innerHTML === '') {
            issuesContainer.innerHTML = '<div style="padding: 20px; text-align: center; color: #10b981;"><i class="bi bi-check-circle" style="font-size: 24px;"></i><br>No issues found!</div>';
        }

        document.getElementById('uploadBtn').style.display = 'inline-flex';
        document.getElementById('validateBtn').style.display = 'none';
    }

    function createIssueItem(issue, type) {
        const item = document.createElement('div');
        item.className = 'issue-item';
        item.innerHTML = `
            <div class="issue-icon ${type}">
                <i class="bi bi-${type === 'error' ? 'x-circle' : 'exclamation-triangle'}"></i>
            </div>
            <div class="issue-content">
                <div class="issue-title">${issue.title || issue.message}</div>
                <div class="issue-desc">${issue.description || issue.details || ''}</div>
            </div>
        `;
        return item;
    }

    // Upload Button Click
    document.getElementById('uploadBtn').addEventListener('click', async function() {
        await startUpload();
    });

    // Start Upload Process
    async function startUpload() {
        updateStepIndicator(4);
        document.getElementById('validationSection').style.display = 'none';
        document.getElementById('progressSection').classList.add('show');
        document.getElementById('actionButtons').style.display = 'none';
        uploadStartTime = Date.now();

        const formData = new FormData();
        pdfFiles.forEach(file => {
            formData.append('pdfFiles', file);
        });
        formData.append('excelFile', excelFile);

        try {
            const response = await fetch('/api/bulk-upload/process', {
                method: 'POST',
                body: formData
            });

            if (!response.ok) {
                throw new Error('Upload failed');
            }

            // Simulate progress
            await simulateProgress(validationResult.totalDocuments);

            const result = await response.json();
            showCompletion(result);

        } catch (error) {
            console.error('Upload error:', error);
            showAlert('Upload failed. Please try again.', 'error');
        }
    }

    // Simulate Upload Progress
    async function simulateProgress(totalDocs) {
        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');
        const uploadLog = document.getElementById('uploadLog');

        for (let i = 1; i <= totalDocs; i++) {
            const percentage = Math.round((i / totalDocs) * 100);
            progressBar.style.width = percentage + '%';
            progressBar.textContent = percentage + '%';
            progressText.textContent = `Processing ${i} of ${totalDocs} documents...`;

            const logItem = document.createElement('div');
            logItem.className = 'log-item';
            logItem.innerHTML = `
                <div class="log-icon processing">
                    <i class="bi bi-arrow-repeat"></i>
                </div>
                <div class="log-text">Uploading document ${i}...</div>
            `;
            uploadLog.appendChild(logItem);
            uploadLog.scrollTop = uploadLog.scrollHeight;

            await new Promise(resolve => setTimeout(resolve, 500));

            logItem.innerHTML = `
                <div class="log-icon success">
                    <i class="bi bi-check"></i>
                </div>
                <div class="log-text">Document ${i} uploaded successfully</div>
            `;
        }
    }

    // Show Completion
    function showCompletion(result) {
        document.getElementById('progressSection').style.display = 'none';
        document.getElementById('completionSection').classList.add('show');

        const endTime = Date.now();
        const totalTime = Math.round((endTime - uploadStartTime) / 1000);

        document.getElementById('successCount').textContent = result.successCount || 0;
        document.getElementById('failedCount').textContent = result.failedCount || 0;
        document.getElementById('totalTime').textContent = totalTime + 's';
    }

    // Update Step Indicator
    function updateStepIndicator(step) {
        for (let i = 1; i <= 4; i++) {
            const indicator = document.getElementById('step' + i + 'Indicator');
            if (i < step) {
                indicator.classList.add('completed');
                indicator.classList.remove('active');
            } else if (i === step) {
                indicator.classList.add('active');
                indicator.classList.remove('completed');
            } else {
                indicator.classList.remove('active', 'completed');
            }
        }
    }

    // Reset Upload
    function resetUpload() {
        pdfFiles = [];
        excelFile = null;
        validationResult = null;

        document.getElementById('folderInput').value = '';
        document.getElementById('excelFileInput').value = '';
        document.getElementById('folderFileInfo').classList.remove('show');
        document.getElementById('excelFileInfo').classList.remove('show');
        document.getElementById('folderUploadCard').classList.remove('has-file');
        document.getElementById('excelUploadCard').classList.remove('has-file');

        document.getElementById('folderSection').style.display = 'grid';
        document.getElementById('excelSection').style.display = 'none';
        document.getElementById('validationSection').classList.remove('show');
        document.getElementById('progressSection').classList.remove('show');
        document.getElementById('completionSection').classList.remove('show');

        document.getElementById('generateTemplateBtn').style.display = 'inline-flex';
        document.getElementById('generateTemplateBtn').disabled = true;
        document.getElementById('validateBtn').style.display = 'none';
        document.getElementById('uploadBtn').style.display = 'none';
        document.getElementById('resetBtn').style.display = 'none';
        document.getElementById('actionButtons').style.display = 'flex';

        updateStepIndicator(1);
    }

    // Utility Functions
    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
    }

    function showAlert(message, type) {
        const alertDiv = document.createElement('div');
        alertDiv.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: ${type === 'error' ? '#ef4444' : '#10b981'};
            color: white;
            padding: 16px 24px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 10000;
            animation: slideInRight 0.3s ease;
        `;
        alertDiv.textContent = message;
        document.body.appendChild(alertDiv);

        setTimeout(() => {
            alertDiv.style.animation = 'slideOutRight 0.3s ease';
            setTimeout(() => alertDiv.remove(), 300);
        }, 3000);
    }

    function goBack() {
        if (confirm('Are you sure you want to go back? Any unsaved progress will be lost.')) {
            window.history.back();
        }
    }
</script>
</body>
</html>