<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tags Management - Codes & Standards</title>
    <!--    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">-->
    <link rel="stylesheet" href="/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
    <!-- Include Sidebar Styles -->
    <th:block th:replace="~{common/sidebar :: sidebar-styles}"></th:block>
    <style>
        body {
            background-color: #f4f6f9;
            margin: 0;
            padding: 0;
            padding-top: 70px;
        }

        .search-box {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .tags-container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .tag-item {
            background: white;
            border: 1px solid #4DA3FF;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            transition: all 0.3s;
            position: relative;
            cursor: pointer;
        }
        .tag-item:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border-color: #4DA3FF;
        }
        .tag-badge {
          position: relative;
          display: inline-flex;
          align-items: center;
          background: #4DA3FF;
          border: 0px;
          border-radius: 5px;
          color: white;
          font-weight: 500;
          font-size: 0.95rem;
          padding: 8px 16px 8px 45px;        /* keep left space always */
          clip-path: polygon(20px 0%, 100% 0%, 100% 100%, 20px 100%, 0 50%);
          /* â†‘ 30px instead of 20% */
          white-space: nowrap;
        }
        .tag-badge::before {
          content: "";
          position: absolute;
          left: 16px;
          top: 50%;
          transform: translateY(-50%);
          width: 10px;
          height: 10px;
          border-radius: 50%;
          background: white;   /* or any color */
        }
        .tag-icon {
            width: 50px;
            height: 50px;
            border-radius: 10px;
            background-color: #fafbfc;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #4DA3FF;
            font-size: 1.5rem;
        }
        .tag-meta {
            font-size: 0.9rem;
            color: #666;
        }
        .action-menu {
            position: absolute;
            top: 20px;
            right: 20px;
        }

        .loading-spinner {
            display: none;
            text-align: center;
            padding: 40px;
        }
        .empty-state {
            text-align: center;
            padding: 60px 20px;
        }
        .empty-state i {
            font-size: 4rem;
            opacity: 0.3;
            color: #667eea;
        }
        .inline-error {
          color: #dc3545;
          font-size: 0.85rem;
        }
        /* Tag card styling */
        .tag-item {
            background: #fff;
            border: 1px solid #e0e6ed;
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            transition: all 0.3s ease;
        }

        .tag-item:hover {
            transform: translateY(-4px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.1);
        }

/* Hover action buttons (hidden by default) */
        .tag-hover-actions {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            gap: 8px;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        /* Show only when hovering on card */
        .tag-item:hover .tag-hover-actions {
            opacity: 1;
            visibility: visible;
        }

        /* Icon buttons */
        .btn-icon {
            border: 1px solid #d1d5db;
            border-radius: 6px;
            background: white;
            padding: 8px 10px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        /* Edit button */
        .edit-btn {
            color: #3b82f6;
            border-color: #3b82f6;
        }
        .edit-btn:hover {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }

        /* Delete button */
        .delete-btn {
            color: #ef4444;
            border-color: #ef4444;
        }
        .delete-btn:hover {
            background: #ef4444;
            color: white;
            border-color: #ef4444;
        }
        #scrollTopBtn {
            display: none;
            position: fixed;
            bottom: 30px;
            right: 30px;
            z-index: 1000;
            background-color: #007bff;
            color: white;
            border: none;
            outline: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            font-size: 20px;
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            transition: background-color 0.3s;
        }

        #scrollTopBtn:hover {
            background-color:#1e3a5f;
        }

        /* Documents Modal Styles */
        .documents-modal-content {
            max-height: 400px;
            overflow-y: auto;
        }

        .document-list-item {
            padding: 12px 15px;
            border-bottom: 1px solid #e5e7eb;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .document-list-item:last-child {
            border-bottom: none;
        }

        .document-list-item:hover {
            background-color: #f3f4f6;
        }

        .document-list-item i {
            color: #4DA3FF;
            font-size: 1.1rem;
        }

        .document-list-item span {
            color: #1a2332;
            font-size: 0.95rem;
            flex: 1;
        }

        .document-list-item .open-icon {
            color: #9ca3af;
            font-size: 0.85rem;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .document-list-item:hover .open-icon {
            opacity: 1;
            color: #4DA3FF;
        }

        .no-documents-message {
            text-align: center;
            padding: 40px 20px;
            color: #6b7a99;
        }

        .no-documents-message i {
            font-size: 3rem;
            opacity: 0.3;
            margin-bottom: 15px;
            display: block;
        }

        .documents-loading {
            text-align: center;
            padding: 40px 20px;
        }

    </style>
</head>
<body>
<!-- Hidden input to store user role from Thymeleaf -->
<input type="hidden" id="userRole" th:value="${#authentication.principal.authorities.iterator().next().authority}">
<input type="hidden" id="userName" th:value="${#authentication.name}">
<!-- Include Top Navbar -->
<div th:replace="~{common/navbar :: navbar}"></div>

<!-- Sidebar + Content -->
<div class="d-flex">
    <!-- Include Sidebar -->
    <div th:replace="~{common/sidebar :: sidebar}"></div>

    <!-- Main Content -->
    <div class="main-content flex-grow-1 p-4">
        <!-- Breadcrumb and Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2 class="mb-1">Tags Management</h2>
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb mb-0">
                        <li class="breadcrumb-item">
                            <a href="javascript:void(0);"
                               onclick="goBack()"
                               class="text-decoration-none">
                                <i class="bi bi-arrow-left me-1"></i> Back
                            </a>
                        </li>
                        <li class="breadcrumb-item">
                            <a th:href="@{/documents}" class="text-decoration-none">
                                <i class="bi bi-house me-1"></i> Home
                            </a>
                        </li>
                        <li class="breadcrumb-item active">Tags Management</li>
                    </ol>
                </nav>
            </div>
            <!-- Create button - visible to Admin and Manager -->
            <button class="btn" id="createTagBtn"
                    data-bs-toggle="modal" data-bs-target="#createTagModal"
                    style="display: none; background-color: #4DA3FF; color:#ffffff;">
                <i class="bi bi-plus-circle me-2"></i> Create Tag
            </button>
        </div>

        <!-- Alert Messages Container -->
        <div id="alertContainer"></div>

        <!-- Search Box -->
        <div class="search-box">
            <div class="row align-items-center">
                <div class="col-md-10">
                    <div class="input-group">
                        <span class="input-group-text bg-white"><i class="bi bi-search"></i></span>
                        <input type="text" class="form-control border-start-0" id="searchInput"
                               placeholder="Search tags by name, creator, or document count...">
                    </div>
                </div>
                <div class="col-md-2 text-end">
                    <span class="text-muted">
                        <i class="bi bi-tags me-2"></i>
                        Tags (<span id="tagCount">0</span>)
                    </span>
                </div>
            </div>
        </div>

        <!-- Loading Spinner -->
        <div class="loading-spinner" id="loadingSpinner">
            <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-3 text-muted">Loading tags...</p>
        </div>

        <!-- Tags List Container -->
        <div class="tags-container" id="tagsContainer">
            <h5 class="mb-3">
                <i class="bi bi-tags me-2"></i>
                All Tags (<span id="totalTagsCount">0</span>)
            </h5>

            <div id="tagsList">
                <!-- Tags will be loaded here dynamically -->
            </div>

            <!-- Empty State -->
            <div class="empty-state" id="emptyState" style="display: none;">
                <i class="bi bi-tags"></i>
                <p class="text-muted mt-3 fs-5">No tags found.</p>
                <button class="btn btn-primary mt-2" id="emptyCreateBtn"
                        data-bs-toggle="modal" data-bs-target="#createTagModal"
                        style="display: none;">
                    <i class="bi bi-plus-circle me-2"></i> Create Your First Tag
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Create Tag Modal -->
<div class="modal fade" id="createTagModal" tabindex="-1"
     data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <form id="createTagForm">
                <div class="modal-header  text-white" style="background-color: #4DA3FF;">
                    <h5 class="modal-title">
                        <i class="bi bi-plus-circle me-2"></i>Create New Tag
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Tag Name <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="createTagName" name="tagName"
                               placeholder="Enter tag name" required minlength="2" maxlength="50">
                        <small class="text-muted">2-50 characters</small>
                        </br>
                        <small class="text-muted">Spaces are not allowed.</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn" style="background-color: #4DA3FF; color:#ffffff;">
                        <i class="bi bi-check-circle me-2"></i>Create Tag
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Tag Modal -->
<div class="modal fade" id="editTagModal" tabindex="-1"
     data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <form id="editTagForm">
                <input type="hidden" id="editTagId">
                <div class="modal-header" style="background-color: #4DA3FF; color:#ffffff;">
                    <h5 class="modal-title">
                        <i class="bi bi-pencil-square me-2"></i>Edit Tag
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Tag Name <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="editTagName" name="tagName"
                               required minlength="2" maxlength="50">
                        <small class="text-muted">2-50 characters</small>
                        </br>
                        <small class="text-muted">Spaces are not allowed.</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn" style="background-color: #4DA3FF; color:#ffffff;">
                        <i class="bi bi-check-circle me-2"></i>Update Tag
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1"
     data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content rounded-3 shadow">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">
                    <i class="bi bi-exclamation-triangle me-2"></i>Delete Tag
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p id="deleteModalMessage">Are you sure you want to delete this tag? This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" id="confirmDeleteBtn" class="btn btn-danger">
                    <i class="bi bi-trash me-2"></i> Delete
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Documents by Tag Modal -->
<div class="modal fade" id="documentsModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content rounded-3 shadow">
            <div class="modal-header" style="background-color: #4DA3FF; color:#ffffff;">
                <h5 class="modal-title">
                    <i class="bi bi-files me-2"></i>Documents using tag: <span id="documentsModalTagName"></span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-0">
                <div class="documents-loading" id="documentsLoading">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2 text-muted">Loading documents...</p>
                </div>
                <div class="documents-modal-content" id="documentsListContainer">
                    <!-- Documents will be loaded here -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Scroll to Top Button -->
<button id="scrollTopBtn" title="Go to top">
    <i class="bi bi-arrow-up"></i>
</button>

<!--<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>-->
<script src="/js/bootstrap.bundle.min.js"></script>
<!-- Include Navbar JavaScript -->
<div th:replace="~{common/navbar :: navbar-js}"></div>

<script>
    // Configuration
    const API_BASE_URL = '/api/tags';

    let allTags = [];
    let createModal, editModal, deleteModal, documentsModal;
    let deleteTagId = null;

    // Get user role from hidden input (populated by Thymeleaf from navbar)
    const userRole = document.getElementById('userRole')?.value || 'Viewer';
    const userName = document.getElementById('userName')?.value || 'User';

    console.log('====== TAGS MANAGEMENT ======');
    console.log('User:', userName);
    console.log('Role:', userRole);
    console.log('============================');

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', async function() {
        // Initialize modals
        createModal = new bootstrap.Modal(document.getElementById('createTagModal'));
        editModal = new bootstrap.Modal(document.getElementById('editTagModal'));
        deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
        documentsModal = new bootstrap.Modal(document.getElementById('documentsModal'));

        // Apply role-based restrictions
        applyRoleBasedRestrictions();

        // Load tags
        await loadTags();

        // Setup event listeners
        setupEventListeners();
    });
    // Scroll to top button
        const scrollTopBtn = document.getElementById("scrollTopBtn");
        if (scrollTopBtn) {
            window.onscroll = function() {
                if (document.body.scrollTop > 200 || document.documentElement.scrollTop > 200) {
                    scrollTopBtn.style.display = "block";
                } else {
                    scrollTopBtn.style.display = "none";
                }
            };

            scrollTopBtn.addEventListener("click", function() {
                window.scrollTo({
                    top: 0,
                    behavior: 'smooth'
                });
            });
        }

    // Apply role-based restrictions
    function applyRoleBasedRestrictions() {
        // Admin and Manager can create/edit/delete
        const canManage = userRole === 'Admin' || userRole === 'Manager';

        console.log('Can manage (Admin or Manager)?', canManage);

        // Show/hide create button based on role
        const createBtn = document.getElementById('createTagBtn');
        const emptyCreateBtn = document.getElementById('emptyCreateBtn');

        if (canManage) {
            if (createBtn) createBtn.style.display = 'block';
            if (emptyCreateBtn) emptyCreateBtn.style.display = 'block';
        } else {
            if (createBtn) createBtn.style.display = 'none';
            if (emptyCreateBtn) emptyCreateBtn.style.display = 'none';
        }
    }

    // Setup all event listeners
    function setupEventListeners() {
        // Create form submit
        document.getElementById('createTagForm').addEventListener('submit', handleCreateTag);

        // Edit form submit
        document.getElementById('editTagForm').addEventListener('submit', handleEditTag);

        // Delete confirmation
        document.getElementById('confirmDeleteBtn').addEventListener('click', handleDeleteTag);

        // Search functionality
        document.getElementById('searchInput').addEventListener('keyup', handleSearch);

        // Reset create form when modal is closed
        document.getElementById('createTagModal').addEventListener('hidden.bs.modal', function() {
            document.getElementById('createTagForm').reset();
        });

        // Reset edit form when modal is closed
        document.getElementById('editTagModal').addEventListener('hidden.bs.modal', function() {
            document.getElementById('editTagForm').reset();
            document.getElementById('editTagId').value = '';
        });
    }

    // Load all tags
    async function loadTags() {
        showLoading(true);
        try {
            const response = await fetch(API_BASE_URL, {
                credentials: 'same-origin',
                headers: {
                    'Accept': 'application/json'
                }
            });

            if (!response.ok) {
                if (response.status === 401 || response.status === 403) {
                    window.location.href = '/login';
                    return;
                }
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            allTags = await response.json();
            console.log('Tags loaded:', allTags.length);
            displayTags(allTags);
            updateTagCount(allTags.length);

        } catch (error) {
            console.error('Error loading tags:', error);
            showAlert('Failed to load tags. Please try again.', 'danger');
        } finally {
            showLoading(false);
        }
    }

    // Display tags in the list
    function displayTags(tags) {
        const tagsList = document.getElementById('tagsList');
        const emptyState = document.getElementById('emptyState');

        if (tags.length === 0) {
            tagsList.innerHTML = '';
            emptyState.style.display = 'block';
            return;
        }

        emptyState.style.display = 'none';
        tagsList.innerHTML = '';

        tags.forEach(tag => {
            const tagItem = createTagElement(tag);
            tagsList.appendChild(tagItem);
        });
    }
   // Create tag element
function createTagElement(tag) {
    const div = document.createElement('div');
    div.className = 'tag-item position-relative';
    div.setAttribute('data-tag-id', tag.id);

    const createdDate = formatDate(tag.createdAt);
    const updatedDate = formatDate(tag.updatedAt);
    const updatedBy = tag.updatedByUsername || 'N/A';
    const createdBy = tag.createdByUsername || 'Unknown';

    // Admin and Manager can edit/delete
    const canManage = userRole === 'Admin' || userRole === 'Manager';

    // Hover action buttons (instead of dropdown)
    const actionsHTML = canManage ? `
        <div class="tag-hover-actions">
            <button class="btn-icon edit-btn" title="Edit"
                onclick="event.stopPropagation(); openEditModal(${tag.id}, '${escapeHtml(tag.tagName).replace(/'/g, "\\'")}')">
                <i class="bi bi-pencil"></i>
            </button>
            <button class="btn-icon delete-btn" title="Delete"
                onclick="event.stopPropagation(); openDeleteModal(${tag.id}, '${escapeHtml(tag.tagName).replace(/'/g, "\\'")}', ${tag.documentCount || 0})">
                <i class="bi bi-trash"></i>
            </button>
        </div>
    ` : '';

    div.innerHTML = `
        <div class="d-flex align-items-start">
            <!-- Tag Icon -->
            <div class="tag-icon me-3">
                <i class="bi bi-tag-fill"></i>
            </div>

            <!-- Tag Details -->
            <div class="flex-grow-1">
                <div class="mb-2">
                    <span class="tag-badge">${escapeHtml(tag.tagName)}</span>
                </div>
                <div class="tag-meta">
                    <span class="me-3">
                        <i class="bi bi-person me-1"></i>
                        Created by <strong>${escapeHtml(createdBy)}</strong>
                    </span>
                    <span class="me-3">
                        <i class="bi bi-calendar me-1"></i>
                        On <span>${createdDate}</span>
                    </span>
                    <span class="me-3">
                        <i class="bi bi-files me-1"></i>
                        <strong>${tag.documentCount || 0}</strong> document(s)
                    </span>
                    <span class="me-3">
                        <i class="bi bi-clock me-1"></i>
                        Updated By <strong>${escapeHtml(updatedBy)}</strong>
                    </span>
                    <span class="me-3">
                        <i class="bi bi-calendar-check me-1"></i>
                        Updated On <span>${updatedDate}</span>
                    </span>
                </div>
            </div>

            ${actionsHTML}
        </div>
    `;

    // Add click event to open documents modal
    div.addEventListener('click', function(e) {
        // Don't trigger if clicking on action buttons
        if (e.target.closest('.tag-hover-actions')) {
            return;
        }
        openDocumentsModal(tag.id, tag.tagName);
    });

    return div;
}

    // Open documents modal
    async function openDocumentsModal(tagId, tagName) {
        // Set the tag name in modal title
        document.getElementById('documentsModalTagName').textContent = tagName;

        // Show loading state
        document.getElementById('documentsLoading').style.display = 'block';
        document.getElementById('documentsListContainer').innerHTML = '';

        // Show modal
        documentsModal.show();

        try {
            // Fetch documents for this tag
            const response = await fetch(`${API_BASE_URL}/${tagId}/documents`, {
                credentials: 'same-origin',
                headers: {
                    'Accept': 'application/json'
                }
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const documents = await response.json();

            // Hide loading
            document.getElementById('documentsLoading').style.display = 'none';

            // Display documents
            displayDocumentsInModal(documents);

        } catch (error) {
            console.error('Error loading documents:', error);
            document.getElementById('documentsLoading').style.display = 'none';
            document.getElementById('documentsListContainer').innerHTML = `
                <div class="no-documents-message">
                    <i class="bi bi-exclamation-circle"></i>
                    <p>Failed to load documents. Please try again.</p>
                </div>
            `;
        }
    }

    // Display documents in modal
    function displayDocumentsInModal(documents) {
        const container = document.getElementById('documentsListContainer');

        if (!documents || documents.length === 0) {
            container.innerHTML = `
                <div class="no-documents-message">
                    <i class="bi bi-file-earmark-x"></i>
                    <p>No documents using this tag</p>
                </div>
            `;
            return;
        }

        let html = '';
        documents.forEach(doc => {
            html += `
                <div class="document-list-item" onclick="openDocument(${doc.id})">
                    <i class="bi bi-file-earmark-text"></i>
                    <span>${escapeHtml(doc.title)}</span>
                    <i class="bi bi-box-arrow-up-right open-icon"></i>
                </div>
            `;
        });

        container.innerHTML = html;
    }

    // Open document in DocViewer
    function openDocument(docId) {
        window.open(`/DocViewer?id=${docId}`, '_blank');
    }

    // Handle create tag
async function handleCreateTag(e) {
    e.preventDefault();

    const input = document.getElementById('createTagName');
    let tagName = input.value.trim().toLowerCase().replace(/\s+/g, '');
    const errorEl = getOrCreateErrorElement(input);

    // Remove old error text
    errorEl.textContent = '';

    // Validation: length
    if (tagName.length < 2 || tagName.length > 50) {
        errorEl.textContent = 'Tag name must be between 2 and 50 characters (no spaces).';
        return;
    }

    // Validation: check duplicate
    const exists = allTags.some(t => t.tagName.toLowerCase() === tagName);
    if (exists) {
        errorEl.textContent = `Tag "${tagName}" already exists.`;
        return;
    }

    try {
        const response = await fetch(API_BASE_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'same-origin',
            body: JSON.stringify({ tagName })
        });

        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.message || 'Failed to create tag');
        }

        createModal.hide();
        input.value = '';
        await loadTags();
        showAlert('Tag created successfully!', 'success');

    } catch (error) {
        errorEl.textContent = error.message || 'Failed to create tag.';
    }
}
// Open edit modal
    function openEditModal(tagId, tagName) {
        document.getElementById('editTagId').value = tagId;
        document.getElementById('editTagName').value = tagName;
        editModal.show();
    }

// Handle edit tag
async function handleEditTag(e) {
    e.preventDefault();

    const input = document.getElementById('editTagName');
    let tagName = input.value.trim().toLowerCase().replace(/\s+/g, '');
    const tagId = document.getElementById('editTagId').value;
    const errorEl = getOrCreateErrorElement(input);

    errorEl.textContent = '';

    if (tagName.length < 2 || tagName.length > 50) {
        errorEl.textContent = 'Tag name must be between 2 and 50 characters (no spaces).';
        return;
    }

    const exists = allTags.some(t => t.tagName.toLowerCase() === tagName && t.id != tagId);
    if (exists) {
        errorEl.textContent = `Tag "${tagName}" already exists.`;
        return;
    }

    try {
        const response = await fetch(`${API_BASE_URL}/${tagId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'same-origin',
            body: JSON.stringify({ tagName })
        });

        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.message || 'Failed to update tag');
        }

        editModal.hide();
        await loadTags();
        showAlert('Tag updated successfully!', 'success');

    } catch (error) {
        errorEl.textContent = error.message || 'Failed to update tag.';
    }
}

// Helper function to show inline error message below input
function getOrCreateErrorElement(input) {
    let errorEl = input.parentElement.querySelector('.text-danger.inline-error');
    if (!errorEl) {
        errorEl = document.createElement('div');
        errorEl.className = 'text-danger inline-error mt-1 small';
        input.parentElement.appendChild(errorEl);
    }
    return errorEl;
}

    // Open delete modal
    function openDeleteModal(tagId, tagName, documentCount) {
    deleteTagId = tagId;

    // Show different message based on document count
    if (documentCount > 0) {
        document.getElementById('deleteModalMessage').innerHTML =
            `Are you sure you want to delete the tag "<strong>${tagName}</strong>"?


            <span class="text-warning"><i class="fas fa-exclamation-triangle"></i>
            This tag is being used by ${documentCount} document(s).
            The tag will be removed from all documents, but the documents will remain intact.</span>`;
    } else {
        document.getElementById('deleteModalMessage').textContent =
            `Are you sure you want to delete the tag "${tagName}"? This action cannot be undone.`;
    }

    deleteModal.show();
}

// Handle delete tag
async function handleDeleteTag() {
    if (!deleteTagId) return;

    try {
        const response = await fetch(`${API_BASE_URL}/${deleteTagId}`, {
            method: 'DELETE',
            credentials: 'same-origin'
        });

        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.message || 'Failed to delete tag');
        }

        showAlert('Tag deleted successfully!', 'success');
        deleteModal.hide();
        deleteTagId = null;
        await loadTags();

    } catch (error) {
        console.error('Error deleting tag:', error);
        showAlert(error.message || 'Failed to delete tag. Please try again.', 'danger');
        deleteModal.hide();
    }
}

    // Handle search
    function handleSearch() {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        const tagItems = document.querySelectorAll('.tag-item');
        let visibleCount = 0;

        tagItems.forEach(item => {
            const text = item.textContent.toLowerCase();
            if (text.includes(searchTerm)) {
                item.style.display = '';
                visibleCount++;
            } else {
                item.style.display = 'none';
            }
        });

        updateTagCount(visibleCount);
    }

    // Update tag count
    function updateTagCount(count) {
        document.getElementById('tagCount').textContent = count;
        document.getElementById('totalTagsCount').textContent = count;
    }

    // Date formatting function
    function formatDate(dateString) {
        if (!dateString || dateString === 'N/A') return 'N/A';

        try {
            const date = new Date(dateString);
            if (isNaN(date.getTime())) return dateString;

            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun',
                          'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

            const day = String(date.getDate()).padStart(2, '0');
            const month = months[date.getMonth()];
            const year = date.getFullYear();

            return `${month} ${day}, ${year}`;
        } catch (error) {
            return dateString;
        }
    }

    // Show alert message
    function showAlert(message, type) {
        const alertContainer = document.getElementById('alertContainer');
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show`;

        const icon = type === 'success' ? 'check-circle-fill' :
                     type === 'danger' ? 'exclamation-circle-fill' :
                     type === 'warning' ? 'exclamation-triangle-fill' :
                     'info-circle-fill';

        alertDiv.innerHTML = `
            <i class="bi bi-${icon} me-2"></i>
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;

        alertContainer.appendChild(alertDiv);

        // Auto-dismiss after 5 seconds
        setTimeout(() => {
            alertDiv.remove();
        }, 5000);
    }

    // Show/hide loading spinner
    function showLoading(show) {
        document.getElementById('loadingSpinner').style.display = show ? 'block' : 'none';
        document.getElementById('tagsContainer').style.display = show ? 'none' : 'block';
    }

    // Escape HTML to prevent XSS
    function escapeHtml(text) {
        if (!text) return '';
        const map = {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#039;'
        };
        return String(text).replace(/[&<>"']/g, m => map[m]);
    }
</script>
<script>
    function goBack() {
        if (document.referrer && document.referrer !== window.location.href) {
            // Go to the referring page if available
            window.history.back();
        } else {
            // Fallback if there's no referrer (like direct load)
            window.location.href = '/documents';
        }
    }
</script>
</body>
</html>